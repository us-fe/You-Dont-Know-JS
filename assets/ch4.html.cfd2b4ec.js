import{_ as n,d as s}from"./app.a957722f.js";const a={},e=s(`<h1 id="you-don-t-know-js-async-performance" tabindex="-1"><a class="header-anchor" href="#you-don-t-know-js-async-performance" aria-hidden="true">#</a> You Don&#39;t Know JS: Async &amp; Performance</h1><h1 id="chapter-4-generators" tabindex="-1"><a class="header-anchor" href="#chapter-4-generators" aria-hidden="true">#</a> Chapter 4: Generators</h1><p>In Chapter 2, we identified two key drawbacks to expressing async flow control with callbacks:</p><ul><li>Callback-based async doesn&#39;t fit how our brain plans out steps of a task.</li><li>Callbacks aren&#39;t trustable or composable because of <em>inversion of control</em>.</li></ul><p>In Chapter 3, we detailed how Promises uninvert the <em>inversion of control</em> of callbacks, restoring trustability/composability.</p><p>Now we turn our attention to expressing async flow control in a sequential, synchronous-looking fashion. The &quot;magic&quot; that makes it possible is ES6 <strong>generators</strong>.</p><h2 id="breaking-run-to-completion" tabindex="-1"><a class="header-anchor" href="#breaking-run-to-completion" aria-hidden="true">#</a> Breaking Run-to-Completion</h2><p>In Chapter 1, we explained an expectation that JS developers almost universally rely on in their code: once a function starts executing, it runs until it completes, and no other code can interrupt and run in between.</p><p>As bizarre as it may seem, ES6 introduces a new type of function that does not behave with the run-to-completion behavior. This new type of function is called a &quot;generator.&quot;</p><p>To understand the implications, let&#39;s consider this example:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	x<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">// &lt;-- what about this line?</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;x:&quot;</span><span class="token punctuation">,</span> x <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	x<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">// x: 3</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>In this example, we know for sure that <code>bar()</code> runs in between <code>x++</code> and <code>console.log(x)</code>. But what if <code>bar()</code> wasn&#39;t there? Obviously, the result would be <code>2</code> instead of <code>3</code>.</p><p>Now let&#39;s twist your brain. What if <code>bar()</code> wasn&#39;t present, but it could still somehow run between the <code>x++</code> and <code>console.log(x)</code> statements? How would that be possible?</p><p>In <strong>preemptive</strong> multithreaded languages, it would essentially be possible for <code>bar()</code> to &quot;interrupt&quot; and run at exactly the right moment between those two statements. But JS is not preemptive, nor is it (currently) multithreaded. And yet, a <strong>cooperative</strong> form of this &quot;interruption&quot; (concurrency) is possible, if <code>foo()</code> itself could somehow indicate a &quot;pause&quot; at that part in the code.</p><p><strong>Note:</strong> I use the word &quot;cooperative&quot; not only because of the connection to classical concurrency terminology (see Chapter 1), but because as you&#39;ll see in the next snippet, the ES6 syntax for indicating a pause point in code is <code>yield</code> -- suggesting a politely <em>cooperative</em> yielding of control.</p><p>Here&#39;s the ES6 code to accomplish such cooperative concurrency:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	x<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token keyword">yield</span><span class="token punctuation">;</span> <span class="token comment">// pause!</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;x:&quot;</span><span class="token punctuation">,</span> x <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	x<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><strong>Note:</strong> You will likely see most other JS documentation/code that will format a generator declaration as <code>function* foo() { .. }</code> instead of as I&#39;ve done here with <code>function *foo() { .. }</code> -- the only difference being the stylistic positioning of the <code>*</code>. The two forms are functionally/syntactically identical, as is a third <code>function*foo() { .. }</code> (no space) form. There are arguments for both styles, but I basically prefer <code>function *foo..</code> because it then matches when I reference a generator in writing with <code>*foo()</code>. If I said only <code>foo()</code>, you wouldn&#39;t know as clearly if I was talking about a generator or a regular function. It&#39;s purely a stylistic preference.</p><p>Now, how can we run the code in that previous snippet such that <code>bar()</code> executes at the point of the <code>yield</code> inside of <code>*foo()</code>?</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// construct an iterator \`it\` to control the generator</span>
<span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// start \`foo()\` here!</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
x<span class="token punctuation">;</span>						<span class="token comment">// 2</span>
<span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
x<span class="token punctuation">;</span>						<span class="token comment">// 3</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">// x: 3</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>OK, there&#39;s quite a bit of new and potentially confusing stuff in those two code snippets, so we&#39;ve got plenty to wade through. But before we explain the different mechanics/syntax with ES6 generators, let&#39;s walk through the behavior flow:</p><ol><li>The <code>it = foo()</code> operation does <em>not</em> execute the <code>*foo()</code> generator yet, but it merely constructs an <em>iterator</em> that will control its execution. More on <em>iterators</em> in a bit.</li><li>The first <code>it.next()</code> starts the <code>*foo()</code> generator, and runs the <code>x++</code> on the first line of <code>*foo()</code>.</li><li><code>*foo()</code> pauses at the <code>yield</code> statement, at which point that first <code>it.next()</code> call finishes. At the moment, <code>*foo()</code> is still running and active, but it&#39;s in a paused state.</li><li>We inspect the value of <code>x</code>, and it&#39;s now <code>2</code>.</li><li>We call <code>bar()</code>, which increments <code>x</code> again with <code>x++</code>.</li><li>We inspect the value of <code>x</code> again, and it&#39;s now <code>3</code>.</li><li>The final <code>it.next()</code> call resumes the <code>*foo()</code> generator from where it was paused, and runs the <code>console.log(..)</code> statement, which uses the current value of <code>x</code> of <code>3</code>.</li></ol><p>Clearly, <code>*foo()</code> started, but did <em>not</em> run-to-completion -- it paused at the <code>yield</code>. We resumed <code>*foo()</code> later, and let it finish, but that wasn&#39;t even required.</p><p>So, a generator is a special kind of function that can start and stop one or more times, and doesn&#39;t necessarily ever have to finish. While it won&#39;t be terribly obvious yet why that&#39;s so powerful, as we go throughout the rest of this chapter, that will be one of the fundamental building blocks we use to construct generators-as-async-flow-control as a pattern for our code.</p><h3 id="input-and-output" tabindex="-1"><a class="header-anchor" href="#input-and-output" aria-hidden="true">#</a> Input and Output</h3><p>A generator function is a special function with the new processing model we just alluded to. But it&#39;s still a function, which means it still has some basic tenets that haven&#39;t changed -- namely, that it still accepts arguments (aka &quot;input&quot;), and that it can still return a value (aka &quot;output&quot;):</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span>y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> x <span class="token operator">*</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> res <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

res<span class="token punctuation">.</span>value<span class="token punctuation">;</span>		<span class="token comment">// 42</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>We pass in the arguments <code>6</code> and <code>7</code> to <code>*foo(..)</code> as the parameters <code>x</code> and <code>y</code>, respectively. And <code>*foo(..)</code> returns the value <code>42</code> back to the calling code.</p><p>We now see a difference with how the generator is invoked compared to a normal function. <code>foo(6,7)</code> obviously looks familiar. But subtly, the <code>*foo(..)</code> generator hasn&#39;t actually run yet as it would have with a function.</p><p>Instead, we&#39;re just creating an <em>iterator</em> object, which we assign to the variable <code>it</code>, to control the <code>*foo(..)</code> generator. Then we call <code>it.next()</code>, which instructs the <code>*foo(..)</code> generator to advance from its current location, stopping either at the next <code>yield</code> or end of the generator.</p><p>The result of that <code>next(..)</code> call is an object with a <code>value</code> property on it holding whatever value (if anything) was returned from <code>*foo(..)</code>. In other words, <code>yield</code> caused a value to be sent out from the generator during the middle of its execution, kind of like an intermediate <code>return</code>.</p><p>Again, it won&#39;t be obvious yet why we need this whole indirect <em>iterator</em> object to control the generator. We&#39;ll get there, I <em>promise</em>.</p><h4 id="iteration-messaging" tabindex="-1"><a class="header-anchor" href="#iteration-messaging" aria-hidden="true">#</a> Iteration Messaging</h4><p>In addition to generators accepting arguments and having return values, there&#39;s even more powerful and compelling input/output messaging capability built into them, via <code>yield</code> and <code>next(..)</code>.</p><p>Consider:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> y <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">yield</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span> <span class="token number">6</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// start \`foo(..)\`</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> res <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> <span class="token number">7</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

res<span class="token punctuation">.</span>value<span class="token punctuation">;</span>		<span class="token comment">// 42</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>First, we pass in <code>6</code> as the parameter <code>x</code>. Then we call <code>it.next()</code>, and it starts up <code>*foo(..)</code>.</p><p>Inside <code>*foo(..)</code>, the <code>var y = x ..</code> statement starts to be processed, but then it runs across a <code>yield</code> expression. At that point, it pauses <code>*foo(..)</code> (in the middle of the assignment statement!), and essentially requests the calling code to provide a result value for the <code>yield</code> expression. Next, we call <code>it.next( 7 )</code>, which is passing the <code>7</code> value back in to <em>be</em> that result of the paused <code>yield</code> expression.</p><p>So, at this point, the assignment statement is essentially <code>var y = 6 * 7</code>. Now, <code>return y</code> returns that <code>42</code> value back as the result of the <code>it.next( 7 )</code> call.</p><p>Notice something very important but also easily confusing, even to seasoned JS developers: depending on your perspective, there&#39;s a mismatch between the <code>yield</code> and the <code>next(..)</code> call. In general, you&#39;re going to have one more <code>next(..)</code> call than you have <code>yield</code> statements -- the preceding snippet has one <code>yield</code> and two <code>next(..)</code> calls.</p><p>Why the mismatch?</p><p>Because the first <code>next(..)</code> always starts a generator, and runs to the first <code>yield</code>. But it&#39;s the second <code>next(..)</code> call that fulfills the first paused <code>yield</code> expression, and the third <code>next(..)</code> would fulfill the second <code>yield</code>, and so on.</p><h5 id="tale-of-two-questions" tabindex="-1"><a class="header-anchor" href="#tale-of-two-questions" aria-hidden="true">#</a> Tale of Two Questions</h5><p>Actually, which code you&#39;re thinking about primarily will affect whether there&#39;s a perceived mismatch or not.</p><p>Consider only the generator code:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> y <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">yield</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> y<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>This <strong>first</strong> <code>yield</code> is basically <em>asking a question</em>: &quot;What value should I insert here?&quot;</p><p>Who&#39;s going to answer that question? Well, the <strong>first</strong> <code>next()</code> has already run to get the generator up to this point, so obviously <em>it</em> can&#39;t answer the question. So, the <strong>second</strong> <code>next(..)</code> call must answer the question <em>posed</em> by the <strong>first</strong> <code>yield</code>.</p><p>See the mismatch -- second-to-first?</p><p>But let&#39;s flip our perspective. Let&#39;s look at it not from the generator&#39;s point of view, but from the iterator&#39;s point of view.</p><p>To properly illustrate this perspective, we also need to explain that messages can go in both directions -- <code>yield ..</code> as an expression can send out messages in response to <code>next(..)</code> calls, and <code>next(..)</code> can send values to a paused <code>yield</code> expression. Consider this slightly adjusted code:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> y <span class="token operator">=</span> x <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">yield</span> <span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// &lt;-- yield a value!</span>
	<span class="token keyword">return</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span> <span class="token number">6</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> res <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// first \`next()\`, don&#39;t pass anything</span>
res<span class="token punctuation">.</span>value<span class="token punctuation">;</span>				<span class="token comment">// &quot;Hello&quot;</span>

res <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> <span class="token number">7</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// pass \`7\` to waiting \`yield\`</span>
res<span class="token punctuation">.</span>value<span class="token punctuation">;</span>				<span class="token comment">// 42</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><code>yield ..</code> and <code>next(..)</code> pair together as a two-way message passing system <strong>during the execution of the generator</strong>.</p><p>So, looking only at the <em>iterator</em> code:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> res <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// first \`next()\`, don&#39;t pass anything</span>
res<span class="token punctuation">.</span>value<span class="token punctuation">;</span>				<span class="token comment">// &quot;Hello&quot;</span>

res <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> <span class="token number">7</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// pass \`7\` to waiting \`yield\`</span>
res<span class="token punctuation">.</span>value<span class="token punctuation">;</span>				<span class="token comment">// 42</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>Note:</strong> We don&#39;t pass a value to the first <code>next()</code> call, and that&#39;s on purpose. Only a paused <code>yield</code> could accept such a value passed by a <code>next(..)</code>, and at the beginning of the generator when we call the first <code>next()</code>, there <strong>is no paused <code>yield</code></strong> to accept such a value. The specification and all compliant browsers just silently <strong>discard</strong> anything passed to the first <code>next()</code>. It&#39;s still a bad idea to pass a value, as you&#39;re just creating silently &quot;failing&quot; code that&#39;s confusing. So, always start a generator with an argument-free <code>next()</code>.</p><p>The first <code>next()</code> call (with nothing passed to it) is basically <em>asking a question</em>: &quot;What <em>next</em> value does the <code>*foo(..)</code> generator have to give me?&quot; And who answers this question? The first <code>yield &quot;hello&quot;</code> expression.</p><p>See? No mismatch there.</p><p>Depending on <em>who</em> you think about asking the question, there is either a mismatch between the <code>yield</code> and <code>next(..)</code> calls, or not.</p><p>But wait! There&#39;s still an extra <code>next()</code> compared to the number of <code>yield</code> statements. So, that final <code>it.next(7)</code> call is again asking the question about what <em>next</em> value the generator will produce. But there&#39;s no more <code>yield</code> statements left to answer, is there? So who answers?</p><p>The <code>return</code> statement answers the question!</p><p>And if there <strong>is no <code>return</code></strong> in your generator -- <code>return</code> is certainly not any more required in generators than in regular functions -- there&#39;s always an assumed/implicit <code>return;</code> (aka <code>return undefined;</code>), which serves the purpose of default answering the question <em>posed</em> by the final <code>it.next(7)</code> call.</p><p>These questions and answers -- the two-way message passing with <code>yield</code> and <code>next(..)</code> -- are quite powerful, but it&#39;s not obvious at all how these mechanisms are connected to async flow control. We&#39;re getting there!</p><h3 id="multiple-iterators" tabindex="-1"><a class="header-anchor" href="#multiple-iterators" aria-hidden="true">#</a> Multiple Iterators</h3><p>It may appear from the syntactic usage that when you use an <em>iterator</em> to control a generator, you&#39;re controlling the declared generator function itself. But there&#39;s a subtlety that&#39;s easy to miss: each time you construct an <em>iterator</em>, you are implicitly constructing an instance of the generator which that <em>iterator</em> will control.</p><p>You can have multiple instances of the same generator running at the same time, and they can even interact:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token number">2</span><span class="token punctuation">;</span>
	z<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> y <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token punctuation">(</span>x <span class="token operator">*</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> z <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> it1 <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> it2 <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> val1 <span class="token operator">=</span> it1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>			<span class="token comment">// 2 &lt;-- yield 2</span>
<span class="token keyword">var</span> val2 <span class="token operator">=</span> it2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>			<span class="token comment">// 2 &lt;-- yield 2</span>

val1 <span class="token operator">=</span> it1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> val2 <span class="token operator">*</span> <span class="token number">10</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>		<span class="token comment">// 40  &lt;-- x:20,  z:2</span>
val2 <span class="token operator">=</span> it2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> val1 <span class="token operator">*</span> <span class="token number">5</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>		<span class="token comment">// 600 &lt;-- x:200, z:3</span>

it1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> val2 <span class="token operator">/</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">// y:300</span>
										<span class="token comment">// 20 300 3</span>
it2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> val1 <span class="token operator">/</span> <span class="token number">4</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">// y:10</span>
										<span class="token comment">// 200 10 3</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>Warning:</strong> The most common usage of multiple instances of the same generator running concurrently is not such interactions, but when the generator is producing its own values without input, perhaps from some independently connected resource. We&#39;ll talk more about value production in the next section.</p><p>Let&#39;s briefly walk through the processing:</p><ol><li>Both instances of <code>*foo()</code> are started at the same time, and both <code>next()</code> calls reveal a <code>value</code> of <code>2</code> from the <code>yield 2</code> statements, respectively.</li><li><code>val2 * 10</code> is <code>2 * 10</code>, which is sent into the first generator instance <code>it1</code>, so that <code>x</code> gets value <code>20</code>. <code>z</code> is incremented from <code>1</code> to <code>2</code>, and then <code>20 * 2</code> is <code>yield</code>ed out, setting <code>val1</code> to <code>40</code>.</li><li><code>val1 * 5</code> is <code>40 * 5</code>, which is sent into the second generator instance <code>it2</code>, so that <code>x</code> gets value <code>200</code>. <code>z</code> is incremented again, from <code>2</code> to <code>3</code>, and then <code>200 * 3</code> is <code>yield</code>ed out, setting <code>val2</code> to <code>600</code>.</li><li><code>val2 / 2</code> is <code>600 / 2</code>, which is sent into the first generator instance <code>it1</code>, so that <code>y</code> gets value <code>300</code>, then printing out <code>20 300 3</code> for its <code>x y z</code> values, respectively.</li><li><code>val1 / 4</code> is <code>40 / 4</code>, which is sent into the second generator instance <code>it2</code>, so that <code>y</code> gets value <code>10</code>, then printing out <code>200 10 3</code> for its <code>x y z</code> values, respectively.</li></ol><p>That&#39;s a &quot;fun&quot; example to run through in your mind. Did you keep it straight?</p><h4 id="interleaving" tabindex="-1"><a class="header-anchor" href="#interleaving" aria-hidden="true">#</a> Interleaving</h4><p>Recall this scenario from the &quot;Run-to-completion&quot; section of Chapter 1:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token operator">++</span><span class="token punctuation">;</span>
	b <span class="token operator">=</span> b <span class="token operator">*</span> a<span class="token punctuation">;</span>
	a <span class="token operator">=</span> b <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	b<span class="token operator">--</span><span class="token punctuation">;</span>
	a <span class="token operator">=</span> <span class="token number">8</span> <span class="token operator">+</span> b<span class="token punctuation">;</span>
	b <span class="token operator">=</span> a <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>With normal JS functions, of course either <code>foo()</code> can run completely first, or <code>bar()</code> can run completely first, but <code>foo()</code> cannot interleave its individual statements with <code>bar()</code>. So, there are only two possible outcomes to the preceding program.</p><p>However, with generators, clearly interleaving (even in the middle of statements!) is possible:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token keyword">yield</span><span class="token punctuation">;</span>
	b <span class="token operator">=</span> b <span class="token operator">*</span> a<span class="token punctuation">;</span>
	a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">yield</span> b<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	b<span class="token operator">--</span><span class="token punctuation">;</span>
	<span class="token keyword">yield</span><span class="token punctuation">;</span>
	a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">yield</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> b<span class="token punctuation">;</span>
	b <span class="token operator">=</span> a <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token keyword">yield</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>Depending on what respective order the <em>iterators</em> controlling <code>*foo()</code> and <code>*bar()</code> are called, the preceding program could produce several different results. In other words, we can actually illustrate (in a sort of fake-ish way) the theoretical &quot;threaded race conditions&quot; circumstances discussed in Chapter 1, by interleaving the two generator iterations over the same shared variables.</p><p>First, let&#39;s make a helper called <code>step(..)</code> that controls an <em>iterator</em>:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">step</span><span class="token punctuation">(</span><span class="token parameter">gen</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> last<span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// whatever is \`yield\`ed out, just</span>
		<span class="token comment">// send it right back in the next time!</span>
		last <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> last <span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><code>step(..)</code> initializes a generator to create its <code>it</code> <em>iterator</em>, then returns a function which, when called, advances the <em>iterator</em> by one step. Additionally, the previously <code>yield</code>ed out value is sent right back in at the <em>next</em> step. So, <code>yield 8</code> will just become <code>8</code> and <code>yield b</code> will just be <code>b</code> (whatever it was at the time of <code>yield</code>).</p><p>Now, just for fun, let&#39;s experiment to see the effects of interleaving these different chunks of <code>*foo()</code> and <code>*bar()</code>. We&#39;ll start with the boring base case, making sure <code>*foo()</code> totally finishes before <code>*bar()</code> (just like we did in Chapter 1):</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// make sure to reset \`a\` and \`b\`</span>
a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> s1 <span class="token operator">=</span> <span class="token function">step</span><span class="token punctuation">(</span> foo <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> s2 <span class="token operator">=</span> <span class="token function">step</span><span class="token punctuation">(</span> bar <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// run \`*foo()\` completely first</span>
<span class="token function">s1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">s1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">s1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// now run \`*bar()\`</span>
<span class="token function">s2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">s2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">s2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">s2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a<span class="token punctuation">,</span> b <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 11 22</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>The end result is <code>11</code> and <code>22</code>, just as it was in the Chapter 1 version. Now let&#39;s mix up the interleaving ordering and see how it changes the final values of <code>a</code> and <code>b</code>:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// make sure to reset \`a\` and \`b\`</span>
a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> s1 <span class="token operator">=</span> <span class="token function">step</span><span class="token punctuation">(</span> foo <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> s2 <span class="token operator">=</span> <span class="token function">step</span><span class="token punctuation">(</span> bar <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">s2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// b--;</span>
<span class="token function">s2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// yield 8</span>
<span class="token function">s1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// a++;</span>
<span class="token function">s2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// a = 8 + b;</span>
			<span class="token comment">// yield 2</span>
<span class="token function">s1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// b = b * a;</span>
			<span class="token comment">// yield b</span>
<span class="token function">s1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// a = b + 3;</span>
<span class="token function">s2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// b = a * 2;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>Before I tell you the results, can you figure out what <code>a</code> and <code>b</code> are after the preceding program? No cheating!</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> a<span class="token punctuation">,</span> b <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 12 18</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>Note:</strong> As an exercise for the reader, try to see how many other combinations of results you can get back rearranging the order of the <code>s1()</code> and <code>s2()</code> calls. Don&#39;t forget you&#39;ll always need three <code>s1()</code> calls and four <code>s2()</code> calls. Recall the discussion earlier about matching <code>next()</code> with <code>yield</code> for the reasons why.</p><p>You almost certainly won&#39;t want to intentionally create <em>this</em> level of interleaving confusion, as it creates incredibly difficult to understand code. But the exercise is interesting and instructive to understand more about how multiple generators can run concurrently in the same shared scope, because there will be places where this capability is quite useful.</p><p>We&#39;ll discuss generator concurrency in more detail at the end of this chapter.</p><h2 id="generator-ing-values" tabindex="-1"><a class="header-anchor" href="#generator-ing-values" aria-hidden="true">#</a> Generator&#39;ing Values</h2><p>In the previous section, we mentioned an interesting use for generators, as a way to produce values. This is <strong>not</strong> the main focus in this chapter, but we&#39;d be remiss if we didn&#39;t cover the basics, especially because this use case is essentially the origin of the name: generators.</p><p>We&#39;re going to take a slight diversion into the topic of <em>iterators</em> for a bit, but we&#39;ll circle back to how they relate to generators and using a generator to <em>generate</em> values.</p><h3 id="producers-and-iterators" tabindex="-1"><a class="header-anchor" href="#producers-and-iterators" aria-hidden="true">#</a> Producers and Iterators</h3><p>Imagine you&#39;re producing a series of values where each value has a definable relationship to the previous value. To do this, you&#39;re going to need a stateful producer that remembers the last value it gave out.</p><p>You can implement something like that straightforwardly using a function closure (see the <em>Scope &amp; Closures</em> title of this series):</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> gimmeSomething <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">var</span> nextVal<span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>nextVal <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			nextVal <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			nextVal <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> nextVal<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">return</span> nextVal<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">gimmeSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 1</span>
<span class="token function">gimmeSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 9</span>
<span class="token function">gimmeSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 33</span>
<span class="token function">gimmeSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 105</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><strong>Note:</strong> The <code>nextVal</code> computation logic here could have been simplified, but conceptually, we don&#39;t want to calculate the <em>next value</em> (aka <code>nextVal</code>) until the <em>next</em> <code>gimmeSomething()</code> call happens, because in general that could be a resource-leaky design for producers of more persistent or resource-limited values than simple <code>number</code>s.</p><p>Generating an arbitrary number series isn&#39;t a terribly realistic example. But what if you were generating records from a data source? You could imagine much the same code.</p><p>In fact, this task is a very common design pattern, usually solved by iterators. An <em>iterator</em> is a well-defined interface for stepping through a series of values from a producer. The JS interface for iterators, as it is in most languages, is to call <code>next()</code> each time you want the next value from the producer.</p><p>We could implement the standard <em>iterator</em> interface for our number series producer:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> something <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">var</span> nextVal<span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token punctuation">{</span>
		<span class="token comment">// needed for \`for..of\` loops</span>
		<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>

		<span class="token comment">// standard iterator interface method</span>
		<span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>nextVal <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				nextVal <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token punctuation">{</span>
				nextVal <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> nextVal<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">done</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span>nextVal <span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

something<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>		<span class="token comment">// 1</span>
something<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>		<span class="token comment">// 9</span>
something<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>		<span class="token comment">// 33</span>
something<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>		<span class="token comment">// 105</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p><strong>Note:</strong> We&#39;ll explain why we need the <code>[Symbol.iterator]: ..</code> part of this code snippet in the &quot;Iterables&quot; section. Syntactically though, two ES6 features are at play. First, the <code>[ .. ]</code> syntax is called a <em>computed property name</em> (see the <em>this &amp; Object Prototypes</em> title of this series). It&#39;s a way in an object literal definition to specify an expression and use the result of that expression as the name for the property. Next, <code>Symbol.iterator</code> is one of ES6&#39;s predefined special <code>Symbol</code> values (see the <em>ES6 &amp; Beyond</em> title of this book series).</p><p>The <code>next()</code> call returns an object with two properties: <code>done</code> is a <code>boolean</code> value signaling the <em>iterator&#39;s</em> complete status; <code>value</code> holds the iteration value.</p><p>ES6 also adds the <code>for..of</code> loop, which means that a standard <em>iterator</em> can automatically be consumed with native loop syntax:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> v <span class="token keyword">of</span> something<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> v <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// don&#39;t let the loop run forever!</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">&gt;</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 1 9 33 105 321 969</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>Note:</strong> Because our <code>something</code> <em>iterator</em> always returns <code>done:false</code>, this <code>for..of</code> loop would run forever, which is why we put the <code>break</code> conditional in. It&#39;s totally OK for iterators to be never-ending, but there are also cases where the <em>iterator</em> will run over a finite set of values and eventually return a <code>done:true</code>.</p><p>The <code>for..of</code> loop automatically calls <code>next()</code> for each iteration -- it doesn&#39;t pass any values in to the <code>next()</code> -- and it will automatically terminate on receiving a <code>done:true</code>. It&#39;s quite handy for looping over a set of data.</p><p>Of course, you could manually loop over iterators, calling <code>next()</code> and checking for the <code>done:true</code> condition to know when to stop:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span>
	<span class="token keyword">var</span> ret<span class="token punctuation">;</span>
	<span class="token punctuation">(</span>ret <span class="token operator">=</span> something<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ret<span class="token punctuation">.</span>done<span class="token punctuation">;</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> ret<span class="token punctuation">.</span>value <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// don&#39;t let the loop run forever!</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">.</span>value <span class="token operator">&gt;</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 1 9 33 105 321 969</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>Note:</strong> This manual <code>for</code> approach is certainly uglier than the ES6 <code>for..of</code> loop syntax, but its advantage is that it affords you the opportunity to pass in values to the <code>next(..)</code> calls if necessary.</p><p>In addition to making your own <em>iterators</em>, many built-in data structures in JS (as of ES6), like <code>array</code>s, also have default <em>iterators</em>:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> v <span class="token keyword">of</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> v <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 1 3 5 7 9</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>The <code>for..of</code> loop asks <code>a</code> for its <em>iterator</em>, and automatically uses it to iterate over <code>a</code>&#39;s values.</p><p><strong>Note:</strong> It may seem a strange omission by ES6, but regular <code>object</code>s intentionally do not come with a default <em>iterator</em> the way <code>array</code>s do. The reasons go deeper than we will cover here. If all you want is to iterate over the properties of an object (with no particular guarantee of ordering), <code>Object.keys(..)</code> returns an <code>array</code>, which can then be used like <code>for (var k of Object.keys(obj)) { ..</code>. Such a <code>for..of</code> loop over an object&#39;s keys would be similar to a <code>for..in</code> loop, except that <code>Object.keys(..)</code> does not include properties from the <code>[[Prototype]]</code> chain while <code>for..in</code> does (see the <em>this &amp; Object Prototypes</em> title of this series).</p><h3 id="iterables" tabindex="-1"><a class="header-anchor" href="#iterables" aria-hidden="true">#</a> Iterables</h3><p>The <code>something</code> object in our running example is called an <em>iterator</em>, as it has the <code>next()</code> method on its interface. But a closely related term is <em>iterable</em>, which is an <code>object</code> that <strong>contains</strong> an <em>iterator</em> that can iterate over its values.</p><p>As of ES6, the way to retrieve an <em>iterator</em> from an <em>iterable</em> is that the <em>iterable</em> must have a function on it, with the name being the special ES6 symbol value <code>Symbol.iterator</code>. When this function is called, it returns an <em>iterator</em>. Though not required, generally each call should return a fresh new <em>iterator</em>.</p><p><code>a</code> in the previous snippet is an <em>iterable</em>. The <code>for..of</code> loop automatically calls its <code>Symbol.iterator</code> function to construct an <em>iterator</em>. But we could of course call the function manually, and use the <em>iterator</em> it returns:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> it <span class="token operator">=</span> a<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>	<span class="token comment">// 1</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>	<span class="token comment">// 3</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>	<span class="token comment">// 5</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>In the previous code listing that defined <code>something</code>, you may have noticed this line:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>iterator<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>That little bit of confusing code is making the <code>something</code> value -- the interface of the <code>something</code> <em>iterator</em> -- also an <em>iterable</em>; it&#39;s now both an <em>iterable</em> and an <em>iterator</em>. Then, we pass <code>something</code> to the <code>for..of</code> loop:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> v <span class="token keyword">of</span> something<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>The <code>for..of</code> loop expects <code>something</code> to be an <em>iterable</em>, so it looks for and calls its <code>Symbol.iterator</code> function. We defined that function to simply <code>return this</code>, so it just gives itself back, and the <code>for..of</code> loop is none the wiser.</p><h3 id="generator-iterator" tabindex="-1"><a class="header-anchor" href="#generator-iterator" aria-hidden="true">#</a> Generator Iterator</h3><p>Let&#39;s turn our attention back to generators, in the context of <em>iterators</em>. A generator can be treated as a producer of values that we extract one at a time through an <em>iterator</em> interface&#39;s <code>next()</code> calls.</p><p>So, a generator itself is not technically an <em>iterable</em>, though it&#39;s very similar -- when you execute the generator, you get an <em>iterator</em> back:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

<span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>We can implement the <code>something</code> infinite number series producer from earlier with a generator, like this:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">something</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> nextVal<span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>nextVal <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			nextVal <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			nextVal <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> nextVal<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">yield</span> nextVal<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>Note:</strong> A <code>while..true</code> loop would normally be a very bad thing to include in a real JS program, at least if it doesn&#39;t have a <code>break</code> or <code>return</code> in it, as it would likely run forever, synchronously, and block/lock-up the browser UI. However, in a generator, such a loop is generally totally OK if it has a <code>yield</code> in it, as the generator will pause at each iteration, <code>yield</code>ing back to the main program and/or to the event loop queue. To put it glibly, &quot;generators put the <code>while..true</code> back in JS programming!&quot;</p><p>That&#39;s a fair bit cleaner and simpler, right? Because the generator pauses at each <code>yield</code>, the state (scope) of the function <code>*something()</code> is kept around, meaning there&#39;s no need for the closure boilerplate to preserve variable state across calls.</p><p>Not only is it simpler code -- we don&#39;t have to make our own <em>iterator</em> interface -- it actually is more reason-able code, because it more clearly expresses the intent. For example, the <code>while..true</code> loop tells us the generator is intended to run forever -- to keep <em>generating</em> values as long as we keep asking for them.</p><p>And now we can use our shiny new <code>*something()</code> generator with a <code>for..of</code> loop, and you&#39;ll see it works basically identically:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> v <span class="token keyword">of</span> <span class="token function">something</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> v <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// don&#39;t let the loop run forever!</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">&gt;</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 1 9 33 105 321 969</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>But don&#39;t skip over <code>for (var v of something()) ..</code>! We didn&#39;t just reference <code>something</code> as a value like in earlier examples, but instead called the <code>*something()</code> generator to get its <em>iterator</em> for the <code>for..of</code> loop to use.</p><p>If you&#39;re paying close attention, two questions may arise from this interaction between the generator and the loop:</p><ul><li>Why couldn&#39;t we say <code>for (var v of something) ..</code>? Because <code>something</code> here is a generator, which is not an <em>iterable</em>. We have to call <code>something()</code> to construct a producer for the <code>for..of</code> loop to iterate over.</li><li>The <code>something()</code> call produces an <em>iterator</em>, but the <code>for..of</code> loop wants an <em>iterable</em>, right? Yep. The generator&#39;s <em>iterator</em> also has a <code>Symbol.iterator</code> function on it, which basically does a <code>return this</code>, just like the <code>something</code> <em>iterable</em> we defined earlier. In other words, a generator&#39;s <em>iterator</em> is also an <em>iterable</em>!</li></ul><h4 id="stopping-the-generator" tabindex="-1"><a class="header-anchor" href="#stopping-the-generator" aria-hidden="true">#</a> Stopping the Generator</h4><p>In the previous example, it would appear the <em>iterator</em> instance for the <code>*something()</code> generator was basically left in a suspended state forever after the <code>break</code> in the loop was called.</p><p>But there&#39;s a hidden behavior that takes care of that for you. &quot;Abnormal completion&quot; (i.e., &quot;early termination&quot;) of the <code>for..of</code> loop -- generally caused by a <code>break</code>, <code>return</code>, or an uncaught exception -- sends a signal to the generator&#39;s <em>iterator</em> for it to terminate.</p><p><strong>Note:</strong> Technically, the <code>for..of</code> loop also sends this signal to the <em>iterator</em> at the normal completion of the loop. For a generator, that&#39;s essentially a moot operation, as the generator&#39;s <em>iterator</em> had to complete first so the <code>for..of</code> loop completed. However, custom <em>iterators</em> might desire to receive this additional signal from <code>for..of</code> loop consumers.</p><p>While a <code>for..of</code> loop will automatically send this signal, you may wish to send the signal manually to an <em>iterator</em>; you do this by calling <code>return(..)</code>.</p><p>If you specify a <code>try..finally</code> clause inside the generator, it will always be run even when the generator is externally completed. This is useful if you need to clean up resources (database connections, etc.):</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">something</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> nextVal<span class="token punctuation">;</span>

		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>nextVal <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				nextVal <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token punctuation">{</span>
				nextVal <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> nextVal<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">yield</span> nextVal<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// cleanup clause</span>
	<span class="token keyword">finally</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;cleaning up!&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>The earlier example with <code>break</code> in the <code>for..of</code> loop will trigger the <code>finally</code> clause. But you could instead manually terminate the generator&#39;s <em>iterator</em> instance from the outside with <code>return(..)</code>:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">something</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> v <span class="token keyword">of</span> it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> v <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// don&#39;t let the loop run forever!</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">&gt;</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
			<span class="token comment">// complete the generator&#39;s iterator</span>
			it<span class="token punctuation">.</span><span class="token function">return</span><span class="token punctuation">(</span> <span class="token string">&quot;Hello World&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// no \`break\` needed here</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 1 9 33 105 321 969</span>
<span class="token comment">// cleaning up!</span>
<span class="token comment">// Hello World</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>When we call <code>it.return(..)</code>, it immediately terminates the generator, which of course runs the <code>finally</code> clause. Also, it sets the returned <code>value</code> to whatever you passed in to <code>return(..)</code>, which is how <code>&quot;Hello World&quot;</code> comes right back out. We also don&#39;t need to include a <code>break</code> now because the generator&#39;s <em>iterator</em> is set to <code>done:true</code>, so the <code>for..of</code> loop will terminate on its next iteration.</p><p>Generators owe their namesake mostly to this <em>consuming produced values</em> use. But again, that&#39;s just one of the uses for generators, and frankly not even the main one we&#39;re concerned with in the context of this book.</p><p>But now that we more fully understand some of the mechanics of how they work, we can <em>next</em> turn our attention to how generators apply to async concurrency.</p><h2 id="iterating-generators-asynchronously" tabindex="-1"><a class="header-anchor" href="#iterating-generators-asynchronously" aria-hidden="true">#</a> Iterating Generators Asynchronously</h2><p>What do generators have to do with async coding patterns, fixing problems with callbacks, and the like? Let&#39;s get to answering that important question.</p><p>We should revisit one of our scenarios from Chapter 3. Let&#39;s recall the callback approach:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">ajax</span><span class="token punctuation">(</span>
		<span class="token string">&quot;http://some.url.1/?x=&quot;</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">&quot;&amp;y=&quot;</span> <span class="token operator">+</span> y<span class="token punctuation">,</span>
		cb
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">foo</span><span class="token punctuation">(</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> text <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>If we wanted to express this same task flow control with a generator, we could do:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span>y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">ajax</span><span class="token punctuation">(</span>
		<span class="token string">&quot;http://some.url.1/?x=&quot;</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">&quot;&amp;y=&quot;</span> <span class="token operator">+</span> y<span class="token punctuation">,</span>
		<span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// throw an error into \`*main()\`</span>
				it<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">// resume \`*main()\` with received \`data\`</span>
				it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> data <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> text <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">foo</span><span class="token punctuation">(</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">31</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> text <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// start it all up!</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>At first glance, this snippet is longer, and perhaps a little more complex looking, than the callback snippet before it. But don&#39;t let that impression get you off track. The generator snippet is actually <strong>much</strong> better! But there&#39;s a lot going on for us to explain.</p><p>First, let&#39;s look at this part of the code, which is the most important:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> text <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">foo</span><span class="token punctuation">(</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">31</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> text <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>Think about how that code works for a moment. We&#39;re calling a normal function <code>foo(..)</code> and we&#39;re apparently able to get back the <code>text</code> from the Ajax call, even though it&#39;s asynchronous.</p><p>How is that possible? If you recall the beginning of Chapter 1, we had almost identical code:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token function">ajax</span><span class="token punctuation">(</span> <span class="token string">&quot;..url 1..&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> data <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>And that code didn&#39;t work! Can you spot the difference? It&#39;s the <code>yield</code> used in a generator.</p><p>That&#39;s the magic! That&#39;s what allows us to have what appears to be blocking, synchronous code, but it doesn&#39;t actually block the whole program; it only pauses/blocks the code in the generator itself.</p><p>In <code>yield foo(11,31)</code>, first the <code>foo(11,31)</code> call is made, which returns nothing (aka <code>undefined</code>), so we&#39;re making a call to request data, but we&#39;re actually then doing <code>yield undefined</code>. That&#39;s OK, because the code is not currently relying on a <code>yield</code>ed value to do anything interesting. We&#39;ll revisit this point later in the chapter.</p><p>We&#39;re not using <code>yield</code> in a message passing sense here, only in a flow control sense to pause/block. Actually, it will have message passing, but only in one direction, after the generator is resumed.</p><p>So, the generator pauses at the <code>yield</code>, essentially asking the question, &quot;what value should I return to assign to the variable <code>text</code>?&quot; Who&#39;s going to answer that question?</p><p>Look at <code>foo(..)</code>. If the Ajax request is successful, we call:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> data <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>That&#39;s resuming the generator with the response data, which means that our paused <code>yield</code> expression receives that value directly, and then as it restarts the generator code, that value gets assigned to the local variable <code>text</code>.</p><p>Pretty cool, huh?</p><p>Take a step back and consider the implications. We have totally synchronous-looking code inside the generator (other than the <code>yield</code> keyword itself), but hidden behind the scenes, inside of <code>foo(..)</code>, the operations can complete asynchronously.</p><p><strong>That&#39;s huge!</strong> That&#39;s a nearly perfect solution to our previously stated problem with callbacks not being able to express asynchrony in a sequential, synchronous fashion that our brains can relate to.</p><p>In essence, we are abstracting the asynchrony away as an implementation detail, so that we can reason synchronously/sequentially about our flow control: &quot;Make an Ajax request, and when it finishes print out the response.&quot; And of course, we just expressed two steps in the flow control, but this same capability extends without bounds, to let us express however many steps we need to.</p><p><strong>Tip:</strong> This is such an important realization, just go back and read the last three paragraphs again to let it sink in!</p><h3 id="synchronous-error-handling" tabindex="-1"><a class="header-anchor" href="#synchronous-error-handling" aria-hidden="true">#</a> Synchronous Error Handling</h3><p>But the preceding generator code has even more goodness to <em>yield</em> to us. Let&#39;s turn our attention to the <code>try..catch</code> inside the generator:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> text <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">foo</span><span class="token punctuation">(</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">31</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> text <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>How does this work? The <code>foo(..)</code> call is asynchronously completing, and doesn&#39;t <code>try..catch</code> fail to catch asynchronous errors, as we looked at in Chapter 3?</p><p>We already saw how the <code>yield</code> lets the assignment statement pause to wait for <code>foo(..)</code> to finish, so that the completed response can be assigned to <code>text</code>. The awesome part is that this <code>yield</code> pausing <em>also</em> allows the generator to <code>catch</code> an error. We throw that error into the generator with this part of the earlier code listing:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// throw an error into \`*main()\`</span>
	it<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>The <code>yield</code>-pause nature of generators means that not only do we get synchronous-looking <code>return</code> values from async function calls, but we can also synchronously <code>catch</code> errors from those async function calls!</p><p>So we&#39;ve seen we can throw errors <em>into</em> a generator, but what about throwing errors <em>out of</em> a generator? Exactly as you&#39;d expect:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">;</span>

	<span class="token keyword">yield</span> x<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// cause an exception!</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>			<span class="token comment">// Hello World</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
	it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> <span class="token number">42</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// TypeError</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>Of course, we could have manually thrown an error with <code>throw ..</code> instead of causing an exception.</p><p>We can even <code>catch</code> the same error that we <code>throw(..)</code> into the generator, essentially giving the generator a chance to handle it but if it doesn&#39;t, the <em>iterator</em> code must handle it:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> x <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">;</span>

	<span class="token comment">// never gets here</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> x <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
	<span class="token comment">// will \`*main()\` handle this error? we&#39;ll see!</span>
	it<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span> <span class="token string">&quot;Oops&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// nope, didn&#39;t handle it!</span>
	console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// Oops</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>Synchronous-looking error handling (via <code>try..catch</code>) with async code is a huge win for readability and reason-ability.</p><h2 id="generators-promises" tabindex="-1"><a class="header-anchor" href="#generators-promises" aria-hidden="true">#</a> Generators + Promises</h2><p>In our previous discussion, we showed how generators can be iterated asynchronously, which is a huge step forward in sequential reason-ability over the spaghetti mess of callbacks. But we lost something very important: the trustability and composability of Promises (see Chapter 3)!</p><p>Don&#39;t worry -- we can get that back. The best of all worlds in ES6 is to combine generators (synchronous-looking async code) with Promises (trustable and composable).</p><p>But how?</p><p>Recall from Chapter 3 the Promise-based approach to our running Ajax example:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span>y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span>
		<span class="token string">&quot;http://some.url.1/?x=&quot;</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">&quot;&amp;y=&quot;</span> <span class="token operator">+</span> y
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">foo</span><span class="token punctuation">(</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">31</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
	<span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> text <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>In our earlier generator code for the running Ajax example, <code>foo(..)</code> returned nothing (<code>undefined</code>), and our <em>iterator</em> control code didn&#39;t care about that <code>yield</code>ed value.</p><p>But here the Promise-aware <code>foo(..)</code> returns a promise after making the Ajax call. That suggests that we could construct a promise with <code>foo(..)</code> and then <code>yield</code> it from the generator, and then the <em>iterator</em> control code would receive that promise.</p><p>But what should the <em>iterator</em> do with the promise?</p><p>It should listen for the promise to resolve (fulfillment or rejection), and then either resume the generator with the fulfillment message or throw an error into the generator with the rejection reason.</p><p>Let me repeat that, because it&#39;s so important. The natural way to get the most out of Promises and generators is <strong>to <code>yield</code> a Promise</strong>, and wire that Promise to control the generator&#39;s <em>iterator</em>.</p><p>Let&#39;s give it a try! First, we&#39;ll put the Promise-aware <code>foo(..)</code> together with the generator <code>*main()</code>:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span>y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span>
		<span class="token string">&quot;http://some.url.1/?x=&quot;</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">&quot;&amp;y=&quot;</span> <span class="token operator">+</span> y
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> text <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">foo</span><span class="token punctuation">(</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">31</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> text <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>The most powerful revelation in this refactor is that the code inside <code>*main()</code> <strong>did not have to change at all!</strong> Inside the generator, whatever values are <code>yield</code>ed out is just an opaque implementation detail, so we&#39;re not even aware it&#39;s happening, nor do we need to worry about it.</p><p>But how are we going to run <code>*main()</code> now? We still have some of the implementation plumbing work to do, to receive and wire up the <code>yield</code>ed promise so that it resumes the generator upon resolution. We&#39;ll start by trying that manually:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> p <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>

<span class="token comment">// wait for the \`p\` promise to resolve</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
	<span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> text <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		it<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>Actually, that wasn&#39;t so painful at all, was it?</p><p>This snippet should look very similar to what we did earlier with the manually wired generator controlled by the error-first callback. Instead of an <code>if (err) { it.throw..</code>, the promise already splits fulfillment (success) and rejection (failure) for us, but otherwise the <em>iterator</em> control is identical.</p><p>Now, we&#39;ve glossed over some important details.</p><p>Most importantly, we took advantage of the fact that we knew that <code>*main()</code> only had one Promise-aware step in it. What if we wanted to be able to Promise-drive a generator no matter how many steps it has? We certainly don&#39;t want to manually write out the Promise chain differently for each generator! What would be much nicer is if there was a way to repeat (aka &quot;loop&quot; over) the iteration control, and each time a Promise comes out, wait on its resolution before continuing.</p><p>Also, what if the generator throws out an error (intentionally or accidentally) during the <code>it.next(..)</code> call? Should we quit, or should we <code>catch</code> it and send it right back in? Similarly, what if we <code>it.throw(..)</code> a Promise rejection into the generator, but it&#39;s not handled, and comes right back out?</p><h3 id="promise-aware-generator-runner" tabindex="-1"><a class="header-anchor" href="#promise-aware-generator-runner" aria-hidden="true">#</a> Promise-Aware Generator Runner</h3><p>The more you start to explore this path, the more you realize, &quot;wow, it&#39;d be great if there was just some utility to do it for me.&quot; And you&#39;re absolutely correct. This is such an important pattern, and you don&#39;t want to get it wrong (or exhaust yourself repeating it over and over), so your best bet is to use a utility that is specifically designed to <em>run</em> Promise-<code>yield</code>ing generators in the manner we&#39;ve illustrated.</p><p>Several Promise abstraction libraries provide just such a utility, including my <em>asynquence</em> library and its <code>runner(..)</code>, which will be discussed in Appendix A of this book.</p><p>But for the sake of learning and illustration, let&#39;s just define our own standalone utility that we&#39;ll call <code>run(..)</code>:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// thanks to Benjamin Gruenbaum (@benjamingr on GitHub) for</span>
<span class="token comment">// big improvements here!</span>
<span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">gen</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> it<span class="token punctuation">;</span>

	<span class="token comment">// initialize the generator in the current context</span>
	it <span class="token operator">=</span> <span class="token function">gen</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">,</span> args <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// return a promise for the generator completing</span>
	<span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span> <span class="token function">handleNext</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
			<span class="token comment">// run to the next yielded value</span>
			<span class="token keyword">var</span> next <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> value <span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">handleResult</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
				<span class="token comment">// generator has completed running?</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">return</span> next<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// otherwise keep going</span>
				<span class="token keyword">else</span> <span class="token punctuation">{</span>
					<span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span> next<span class="token punctuation">.</span>value <span class="token punctuation">)</span>
						<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
							<span class="token comment">// resume the async loop on</span>
							<span class="token comment">// success, sending the resolved</span>
							<span class="token comment">// value back into the generator</span>
							handleNext<span class="token punctuation">,</span>

							<span class="token comment">// if \`value\` is a rejected</span>
							<span class="token comment">// promise, propagate error back</span>
							<span class="token comment">// into the generator for its own</span>
							<span class="token comment">// error handling</span>
							<span class="token keyword">function</span> <span class="token function">handleErr</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
								<span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>
									it<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span>
								<span class="token punctuation">)</span>
								<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> handleResult <span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>As you can see, it&#39;s a quite a bit more complex than you&#39;d probably want to author yourself, and you especially wouldn&#39;t want to repeat this code for each generator you use. So, a utility/library helper is definitely the way to go. Nevertheless, I encourage you to spend a few minutes studying that code listing to get a better sense of how to manage the generator+Promise negotiation.</p><p>How would you use <code>run(..)</code> with <code>*main()</code> in our <em>running</em> Ajax example?</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// ..</span>
<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span> main <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>That&#39;s it! The way we wired <code>run(..)</code>, it will automatically advance the generator you pass to it, asynchronously until completion.</p><p><strong>Note:</strong> The <code>run(..)</code> we defined returns a promise which is wired to resolve once the generator is complete, or receive an uncaught exception if the generator doesn&#39;t handle it. We don&#39;t show that capability here, but we&#39;ll come back to it later in the chapter.</p><h4 id="es7-async-and-await" tabindex="-1"><a class="header-anchor" href="#es7-async-and-await" aria-hidden="true">#</a> ES7: <code>async</code> and <code>await</code>?</h4><p>The preceding pattern -- generators yielding Promises that then control the generator&#39;s <em>iterator</em> to advance it to completion -- is such a powerful and useful approach, it would be nicer if we could do it without the clutter of the library utility helper (aka <code>run(..)</code>).</p><p>There&#39;s probably good news on that front. At the time of this writing, there&#39;s early but strong support for a proposal for more syntactic addition in this realm for the post-ES6, ES7-ish timeframe. Obviously, it&#39;s too early to guarantee the details, but there&#39;s a pretty decent chance it will shake out similar to the following:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span>y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span>
		<span class="token string">&quot;http://some.url.1/?x=&quot;</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">&quot;&amp;y=&quot;</span> <span class="token operator">+</span> y
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> text <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">foo</span><span class="token punctuation">(</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">31</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> text <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>As you can see, there&#39;s no <code>run(..)</code> call (meaning no need for a library utility!) to invoke and drive <code>main()</code> -- it&#39;s just called as a normal function. Also, <code>main()</code> isn&#39;t declared as a generator function anymore; it&#39;s a new kind of function: <code>async function</code>. And finally, instead of <code>yield</code>ing a Promise, we <code>await</code> for it to resolve.</p><p>The <code>async function</code> automatically knows what to do if you <code>await</code> a Promise -- it will pause the function (just like with generators) until the Promise resolves. We didn&#39;t illustrate it in this snippet, but calling an async function like <code>main()</code> automatically returns a promise that&#39;s resolved whenever the function finishes completely.</p><p><strong>Tip:</strong> The <code>async</code> / <code>await</code> syntax should look very familiar to readers with experience in C#, because it&#39;s basically identical.</p><p>The proposal essentially codifies support for the pattern we&#39;ve already derived, into a syntactic mechanism: combining Promises with sync-looking flow control code. That&#39;s the best of both worlds combined, to effectively address practically all of the major concerns we outlined with callbacks.</p><p>The mere fact that such a ES7-ish proposal already exists and has early support and enthusiasm is a major vote of confidence in the future importance of this async pattern.</p><h3 id="promise-concurrency-in-generators" tabindex="-1"><a class="header-anchor" href="#promise-concurrency-in-generators" aria-hidden="true">#</a> Promise Concurrency in Generators</h3><p>So far, all we&#39;ve demonstrated is a single-step async flow with Promises+generators. But real-world code will often have many async steps.</p><p>If you&#39;re not careful, the sync-looking style of generators may lull you into complacency with how you structure your async concurrency, leading to suboptimal performance patterns. So we want to spend a little time exploring the options.</p><p>Imagine a scenario where you need to fetch data from two different sources, then combine those responses to make a third request, and finally print out the last response. We explored a similar scenario with Promises in Chapter 3, but let&#39;s reconsider it in the context of generators.</p><p>Your first instinct might be something like:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.1&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> r2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.2&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span>
		<span class="token string">&quot;http://some.url.3/?v=&quot;</span> <span class="token operator">+</span> r1 <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> r2
	<span class="token punctuation">)</span><span class="token punctuation">;</span>

	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> r3 <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// use previously defined \`run(..)\` utility</span>
<span class="token function">run</span><span class="token punctuation">(</span> foo <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>This code will work, but in the specifics of our scenario, it&#39;s not optimal. Can you spot why?</p><p>Because the <code>r1</code> and <code>r2</code> requests can -- and for performance reasons, <em>should</em> -- run concurrently, but in this code they will run sequentially; the <code>&quot;http://some.url.2&quot;</code> URL isn&#39;t Ajax fetched until after the <code>&quot;http://some.url.1&quot;</code> request is finished. These two requests are independent, so the better performance approach would likely be to have them run at the same time.</p><p>But how exactly would you do that with a generator and <code>yield</code>? We know that <code>yield</code> is only a single pause point in the code, so you can&#39;t really do two pauses at the same time.</p><p>The most natural and effective answer is to base the async flow on Promises, specifically on their capability to manage state in a time-independent fashion (see &quot;Future Value&quot; in Chapter 3).</p><p>The simplest approach:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// make both requests &quot;in parallel&quot;</span>
	<span class="token keyword">var</span> p1 <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.1&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.2&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// wait until both promises resolve</span>
	<span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">yield</span> p1<span class="token punctuation">;</span>
	<span class="token keyword">var</span> r2 <span class="token operator">=</span> <span class="token keyword">yield</span> p2<span class="token punctuation">;</span>

	<span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span>
		<span class="token string">&quot;http://some.url.3/?v=&quot;</span> <span class="token operator">+</span> r1 <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> r2
	<span class="token punctuation">)</span><span class="token punctuation">;</span>

	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> r3 <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// use previously defined \`run(..)\` utility</span>
<span class="token function">run</span><span class="token punctuation">(</span> foo <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>Why is this different from the previous snippet? Look at where the <code>yield</code> is and is not. <code>p1</code> and <code>p2</code> are promises for Ajax requests made concurrently (aka &quot;in parallel&quot;). It doesn&#39;t matter which one finishes first, because promises will hold onto their resolved state for as long as necessary.</p><p>Then we use two subsequent <code>yield</code> statements to wait for and retrieve the resolutions from the promises (into <code>r1</code> and <code>r2</code>, respectively). If <code>p1</code> resolves first, the <code>yield p1</code> resumes first then waits on the <code>yield p2</code> to resume. If <code>p2</code> resolves first, it will just patiently hold onto that resolution value until asked, but the <code>yield p1</code> will hold on first, until <code>p1</code> resolves.</p><p>Either way, both <code>p1</code> and <code>p2</code> will run concurrently, and both have to finish, in either order, before the <code>r3 = yield request..</code> Ajax request will be made.</p><p>If that flow control processing model sounds familiar, it&#39;s basically the same as what we identified in Chapter 3 as the &quot;gate&quot; pattern, enabled by the <code>Promise.all([ .. ])</code> utility. So, we could also express the flow control like this:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// make both requests &quot;in parallel,&quot; and</span>
	<span class="token comment">// wait until both promises resolve</span>
	<span class="token keyword">var</span> results <span class="token operator">=</span> <span class="token keyword">yield</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span> <span class="token punctuation">[</span>
		<span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.1&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.2&quot;</span> <span class="token punctuation">)</span>
	<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">var</span> r1 <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> r2 <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span>
		<span class="token string">&quot;http://some.url.3/?v=&quot;</span> <span class="token operator">+</span> r1 <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> r2
	<span class="token punctuation">)</span><span class="token punctuation">;</span>

	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> r3 <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// use previously defined \`run(..)\` utility</span>
<span class="token function">run</span><span class="token punctuation">(</span> foo <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><strong>Note:</strong> As we discussed in Chapter 3, we can even use ES6 destructuring assignment to simplify the <code>var r1 = .. var r2 = ..</code> assignments, with <code>var [r1,r2] = results</code>.</p><p>In other words, all of the concurrency capabilities of Promises are available to us in the generator+Promise approach. So in any place where you need more than sequential this-then-that async flow control steps, Promises are likely your best bet.</p><h4 id="promises-hidden" tabindex="-1"><a class="header-anchor" href="#promises-hidden" aria-hidden="true">#</a> Promises, Hidden</h4><p>As a word of stylistic caution, be careful about how much Promise logic you include <strong>inside your generators</strong>. The whole point of using generators for asynchrony in the way we&#39;ve described is to create simple, sequential, sync-looking code, and to hide as much of the details of asynchrony away from that code as possible.</p><p>For example, this might be a cleaner approach:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// note: normal function, not generator</span>
<span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token parameter">url1<span class="token punctuation">,</span>url2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span> <span class="token punctuation">[</span>
		<span class="token function">request</span><span class="token punctuation">(</span> url1 <span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token function">request</span><span class="token punctuation">(</span> url2 <span class="token punctuation">)</span>
	<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// hide the Promise-based concurrency details</span>
	<span class="token comment">// inside \`bar(..)\`</span>
	<span class="token keyword">var</span> results <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">bar</span><span class="token punctuation">(</span>
		<span class="token string">&quot;http://some.url.1&quot;</span><span class="token punctuation">,</span>
		<span class="token string">&quot;http://some.url.2&quot;</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">var</span> r1 <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> r2 <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span>
		<span class="token string">&quot;http://some.url.3/?v=&quot;</span> <span class="token operator">+</span> r1 <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> r2
	<span class="token punctuation">)</span><span class="token punctuation">;</span>

	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> r3 <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// use previously defined \`run(..)\` utility</span>
<span class="token function">run</span><span class="token punctuation">(</span> foo <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>Inside <code>*foo()</code>, it&#39;s cleaner and clearer that all we&#39;re doing is just asking <code>bar(..)</code> to get us some <code>results</code>, and we&#39;ll <code>yield</code>-wait on that to happen. We don&#39;t have to care that under the covers a <code>Promise.all([ .. ])</code> Promise composition will be used to make that happen.</p><p><strong>We treat asynchrony, and indeed Promises, as an implementation detail.</strong></p><p>Hiding your Promise logic inside a function that you merely call from your generator is especially useful if you&#39;re going to do a sophisticated series flow-control. For example:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span>	Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span> <span class="token punctuation">[</span>
		  <span class="token function">baz</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
		  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
		  Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span> <span class="token punctuation">[</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span>
		<span class="token punctuation">]</span> <span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>That kind of logic is sometimes required, and if you dump it directly inside your generator(s), you&#39;ve defeated most of the reason why you would want to use generators in the first place. We <em>should</em> intentionally abstract such details away from our generator code so that they don&#39;t clutter up the higher level task expression.</p><p>Beyond creating code that is both functional and performant, you should also strive to make code that is as reason-able and maintainable as possible.</p><p><strong>Note:</strong> Abstraction is not <em>always</em> a healthy thing for programming -- many times it can increase complexity in exchange for terseness. But in this case, I believe it&#39;s much healthier for your generator+Promise async code than the alternatives. As with all such advice, though, pay attention to your specific situations and make proper decisions for you and your team.</p><h2 id="generator-delegation" tabindex="-1"><a class="header-anchor" href="#generator-delegation" aria-hidden="true">#</a> Generator Delegation</h2><p>In the previous section, we showed calling regular functions from inside a generator, and how that remains a useful technique for abstracting away implementation details (like async Promise flow). But the main drawback of using a normal function for this task is that it has to behave by the normal function rules, which means it cannot pause itself with <code>yield</code> like a generator can.</p><p>It may then occur to you that you might try to call one generator from another generator, using our <code>run(..)</code> helper, such as:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> r2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.2&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.3/?v=&quot;</span> <span class="token operator">+</span> r2 <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> r3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.1&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// &quot;delegating&quot; to \`*foo()\` via \`run(..)\`</span>
	<span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">run</span><span class="token punctuation">(</span> foo <span class="token punctuation">)</span><span class="token punctuation">;</span>

	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> r3 <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span> bar <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>We run <code>*foo()</code> inside of <code>*bar()</code> by using our <code>run(..)</code> utility again. We take advantage here of the fact that the <code>run(..)</code> we defined earlier returns a promise which is resolved when its generator is run to completion (or errors out), so if we <code>yield</code> out to a <code>run(..)</code> instance the promise from another <code>run(..)</code> call, it automatically pauses <code>*bar()</code> until <code>*foo()</code> finishes.</p><p>But there&#39;s an even better way to integrate calling <code>*foo()</code> into <code>*bar()</code>, and it&#39;s called <code>yield</code>-delegation. The special syntax for <code>yield</code>-delegation is: <code>yield * __</code> (notice the extra <code>*</code>). Before we see it work in our previous example, let&#39;s look at a simpler scenario:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;\`*foo()\` starting&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">yield</span> <span class="token number">3</span><span class="token punctuation">;</span>
	<span class="token keyword">yield</span> <span class="token number">4</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;\`*foo()\` finished&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">yield</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">yield</span> <span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token keyword">yield</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// \`yield\`-delegation!</span>
	<span class="token keyword">yield</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>	<span class="token comment">// 1</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>	<span class="token comment">// 2</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>	<span class="token comment">// \`*foo()\` starting</span>
					<span class="token comment">// 3</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>	<span class="token comment">// 4</span>
it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>	<span class="token comment">// \`*foo()\` finished</span>
					<span class="token comment">// 5</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><strong>Note:</strong> Similar to a note earlier in the chapter where I explained why I prefer <code>function *foo() ..</code> instead of <code>function* foo() ..</code>, I also prefer -- differing from most other documentation on the topic -- to say <code>yield *foo()</code> instead of <code>yield* foo()</code>. The placement of the <code>*</code> is purely stylistic and up to your best judgment. But I find the consistency of styling attractive.</p><p>How does the <code>yield *foo()</code> delegation work?</p><p>First, calling <code>foo()</code> creates an <em>iterator</em> exactly as we&#39;ve already seen. Then, <code>yield *</code> delegates/transfers the <em>iterator</em> instance control (of the present <code>*bar()</code> generator) over to this other <code>*foo()</code> <em>iterator</em>.</p><p>So, the first two <code>it.next()</code> calls are controlling <code>*bar()</code>, but when we make the third <code>it.next()</code> call, now <code>*foo()</code> starts up, and now we&#39;re controlling <code>*foo()</code> instead of <code>*bar()</code>. That&#39;s why it&#39;s called delegation -- <code>*bar()</code> delegated its iteration control to <code>*foo()</code>.</p><p>As soon as the <code>it</code> <em>iterator</em> control exhausts the entire <code>*foo()</code> <em>iterator</em>, it automatically returns to controlling <code>*bar()</code>.</p><p>So now back to the previous example with the three sequential Ajax requests:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> r2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.2&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.3/?v=&quot;</span> <span class="token operator">+</span> r2 <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> r3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.1&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// &quot;delegating&quot; to \`*foo()\` via \`yield*\`</span>
	<span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> r3 <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span> bar <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>The only difference between this snippet and the version used earlier is the use of <code>yield *foo()</code> instead of the previous <code>yield run(foo)</code>.</p><p><strong>Note:</strong> <code>yield *</code> yields iteration control, not generator control; when you invoke the <code>*foo()</code> generator, you&#39;re now <code>yield</code>-delegating to its <em>iterator</em>. But you can actually <code>yield</code>-delegate to any <em>iterable</em>; <code>yield *[1,2,3]</code> would consume the default <em>iterator</em> for the <code>[1,2,3]</code> array value.</p><h3 id="why-delegation" tabindex="-1"><a class="header-anchor" href="#why-delegation" aria-hidden="true">#</a> Why Delegation?</h3><p>The purpose of <code>yield</code>-delegation is mostly code organization, and in that way is symmetrical with normal function calling.</p><p>Imagine two modules that respectively provide methods <code>foo()</code> and <code>bar()</code>, where <code>bar()</code> calls <code>foo()</code>. The reason the two are separate is generally because the proper organization of code for the program calls for them to be in separate functions. For example, there may be cases where <code>foo()</code> is called standalone, and other places where <code>bar()</code> calls <code>foo()</code>.</p><p>For all these exact same reasons, keeping generators separate aids in program readability, maintenance, and debuggability. In that respect, <code>yield *</code> is a syntactic shortcut for manually iterating over the steps of <code>*foo()</code> while inside of <code>*bar()</code>.</p><p>Such manual approach would be especially complex if the steps in <code>*foo()</code> were asynchronous, which is why you&#39;d probably need to use that <code>run(..)</code> utility to do it. And as we&#39;ve shown, <code>yield *foo()</code> eliminates the need for a sub-instance of the <code>run(..)</code> utility (like <code>run(foo)</code>).</p><h3 id="delegating-messages" tabindex="-1"><a class="header-anchor" href="#delegating-messages" aria-hidden="true">#</a> Delegating Messages</h3><p>You may wonder how this <code>yield</code>-delegation works not just with <em>iterator</em> control but with the two-way message passing. Carefully follow the flow of messages in and out, through the <code>yield</code>-delegation:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;inside \`*foo()\`:&quot;</span><span class="token punctuation">,</span> <span class="token keyword">yield</span> <span class="token string">&quot;B&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;inside \`*foo()\`:&quot;</span><span class="token punctuation">,</span> <span class="token keyword">yield</span> <span class="token string">&quot;C&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token string">&quot;D&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;inside \`*bar()\`:&quot;</span><span class="token punctuation">,</span> <span class="token keyword">yield</span> <span class="token string">&quot;A&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// \`yield\`-delegation!</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;inside \`*bar()\`:&quot;</span><span class="token punctuation">,</span> <span class="token keyword">yield</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;inside \`*bar()\`:&quot;</span><span class="token punctuation">,</span> <span class="token keyword">yield</span> <span class="token string">&quot;E&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token string">&quot;F&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;outside:&quot;</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// outside: A</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;outside:&quot;</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// inside \`*bar()\`: 1</span>
<span class="token comment">// outside: B</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;outside:&quot;</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// inside \`*foo()\`: 2</span>
<span class="token comment">// outside: C</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;outside:&quot;</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// inside \`*foo()\`: 3</span>
<span class="token comment">// inside \`*bar()\`: D</span>
<span class="token comment">// outside: E</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;outside:&quot;</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> <span class="token number">4</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// inside \`*bar()\`: 4</span>
<span class="token comment">// outside: F</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>Pay particular attention to the processing steps after the <code>it.next(3)</code> call:</p><ol><li>The <code>3</code> value is passed (through the <code>yield</code>-delegation in <code>*bar()</code>) into the waiting <code>yield &quot;C&quot;</code> expression inside of <code>*foo()</code>.</li><li><code>*foo()</code> then calls <code>return &quot;D&quot;</code>, but this value doesn&#39;t get returned all the way back to the outside <code>it.next(3)</code> call.</li><li>Instead, the <code>&quot;D&quot;</code> value is sent as the result of the waiting <code>yield *foo()</code> expression inside of <code>*bar()</code> -- this <code>yield</code>-delegation expression has essentially been paused while all of <code>*foo()</code> was exhausted. So <code>&quot;D&quot;</code> ends up inside of <code>*bar()</code> for it to print out.</li><li><code>yield &quot;E&quot;</code> is called inside of <code>*bar()</code>, and the <code>&quot;E&quot;</code> value is yielded to the outside as the result of the <code>it.next(3)</code> call.</li></ol><p>From the perspective of the external <em>iterator</em> (<code>it</code>), it doesn&#39;t appear any differently between controlling the initial generator or a delegated one.</p><p>In fact, <code>yield</code>-delegation doesn&#39;t even have to be directed to another generator; it can just be directed to a non-generator, general <em>iterable</em>. For example:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;inside \`*bar()\`:&quot;</span><span class="token punctuation">,</span> <span class="token keyword">yield</span> <span class="token string">&quot;A&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// \`yield\`-delegation to a non-generator!</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;inside \`*bar()\`:&quot;</span><span class="token punctuation">,</span> <span class="token keyword">yield</span> <span class="token operator">*</span><span class="token punctuation">[</span> <span class="token string">&quot;B&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;C&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;D&quot;</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;inside \`*bar()\`:&quot;</span><span class="token punctuation">,</span> <span class="token keyword">yield</span> <span class="token string">&quot;E&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token string">&quot;F&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;outside:&quot;</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// outside: A</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;outside:&quot;</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// inside \`*bar()\`: 1</span>
<span class="token comment">// outside: B</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;outside:&quot;</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// outside: C</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;outside:&quot;</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// outside: D</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;outside:&quot;</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> <span class="token number">4</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// inside \`*bar()\`: undefined</span>
<span class="token comment">// outside: E</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;outside:&quot;</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> <span class="token number">5</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// inside \`*bar()\`: 5</span>
<span class="token comment">// outside: F</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>Notice the differences in where the messages were received/reported between this example and the one previous.</p><p>Most strikingly, the default <code>array</code> <em>iterator</em> doesn&#39;t care about any messages sent in via <code>next(..)</code> calls, so the values <code>2</code>, <code>3</code>, and <code>4</code> are essentially ignored. Also, because that <em>iterator</em> has no explicit <code>return</code> value (unlike the previously used <code>*foo()</code>), the <code>yield *</code> expression gets an <code>undefined</code> when it finishes.</p><h4 id="exceptions-delegated-too" tabindex="-1"><a class="header-anchor" href="#exceptions-delegated-too" aria-hidden="true">#</a> Exceptions Delegated, Too!</h4><p>In the same way that <code>yield</code>-delegation transparently passes messages through in both directions, errors/exceptions also pass in both directions:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token keyword">yield</span> <span class="token string">&quot;B&quot;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;error caught inside \`*foo()\`:&quot;</span><span class="token punctuation">,</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">yield</span> <span class="token string">&quot;C&quot;</span><span class="token punctuation">;</span>

	<span class="token keyword">throw</span> <span class="token string">&quot;D&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">yield</span> <span class="token string">&quot;A&quot;</span><span class="token punctuation">;</span>

	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		<span class="token keyword">yield</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;error caught inside \`*bar()\`:&quot;</span><span class="token punctuation">,</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">yield</span> <span class="token string">&quot;E&quot;</span><span class="token punctuation">;</span>

	<span class="token keyword">yield</span> <span class="token operator">*</span><span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// note: can&#39;t get here!</span>
	<span class="token keyword">yield</span> <span class="token string">&quot;G&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">baz</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">throw</span> <span class="token string">&quot;F&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;outside:&quot;</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// outside: A</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;outside:&quot;</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// outside: B</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;outside:&quot;</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// error caught inside \`*foo()\`: 2</span>
<span class="token comment">// outside: C</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;outside:&quot;</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// error caught inside \`*bar()\`: D</span>
<span class="token comment">// outside: E</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;outside:&quot;</span><span class="token punctuation">,</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> <span class="token number">4</span> <span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;error caught outside:&quot;</span><span class="token punctuation">,</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// error caught outside: F</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><p>Some things to note from this snippet:</p><ol><li>When we call <code>it.throw(2)</code>, it sends the error message <code>2</code> into <code>*bar()</code>, which delegates that to <code>*foo()</code>, which then <code>catch</code>es it and handles it gracefully. Then, the <code>yield &quot;C&quot;</code> sends <code>&quot;C&quot;</code> back out as the return <code>value</code> from the <code>it.throw(2)</code> call.</li><li>The <code>&quot;D&quot;</code> value that&#39;s next <code>throw</code>n from inside <code>*foo()</code> propagates out to <code>*bar()</code>, which <code>catch</code>es it and handles it gracefully. Then the <code>yield &quot;E&quot;</code> sends <code>&quot;E&quot;</code> back out as the return <code>value</code> from the <code>it.next(3)</code> call.</li><li>Next, the exception <code>throw</code>n from <code>*baz()</code> isn&#39;t caught in <code>*bar()</code> -- though we did <code>catch</code> it outside -- so both <code>*baz()</code> and <code>*bar()</code> are set to a completed state. After this snippet, you would not be able to get the <code>&quot;G&quot;</code> value out with any subsequent <code>next(..)</code> call(s) -- they will just return <code>undefined</code> for <code>value</code>.</li></ol><h3 id="delegating-asynchrony" tabindex="-1"><a class="header-anchor" href="#delegating-asynchrony" aria-hidden="true">#</a> Delegating Asynchrony</h3><p>Let&#39;s finally get back to our earlier <code>yield</code>-delegation example with the multiple sequential Ajax requests:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> r2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.2&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.3/?v=&quot;</span> <span class="token operator">+</span> r2 <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> r3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.1&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">var</span> r3 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> r3 <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span> bar <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>Instead of calling <code>yield run(foo)</code> inside of <code>*bar()</code>, we just call <code>yield *foo()</code>.</p><p>In the previous version of this example, the Promise mechanism (controlled by <code>run(..)</code>) was used to transport the value from <code>return r3</code> in <code>*foo()</code> to the local variable <code>r3</code> inside <code>*bar()</code>. Now, that value is just returned back directly via the <code>yield *</code> mechanics.</p><p>Otherwise, the behavior is pretty much identical.</p><h3 id="delegating-recursion" tabindex="-1"><a class="header-anchor" href="#delegating-recursion" aria-hidden="true">#</a> Delegating &quot;Recursion&quot;</h3><p>Of course, <code>yield</code>-delegation can keep following as many delegation steps as you wire up. You could even use <code>yield</code>-delegation for async-capable generator &quot;recursion&quot; -- a generator <code>yield</code>-delegating to itself:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>val <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// generator recursion</span>
		val <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span> val <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url/?v=&quot;</span> <span class="token operator">+</span> val <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> r1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> r1 <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span> bar <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>Note:</strong> Our <code>run(..)</code> utility could have been called with <code>run( foo, 3 )</code>, because it supports additional parameters being passed along to the initialization of the generator. However, we used a parameter-free <code>*bar()</code> here to highlight the flexibility of <code>yield *</code>.</p><p>What processing steps follow from that code? Hang on, this is going to be quite intricate to describe in detail:</p><ol><li><code>run(bar)</code> starts up the <code>*bar()</code> generator.</li><li><code>foo(3)</code> creates an <em>iterator</em> for <code>*foo(..)</code> and passes <code>3</code> as its <code>val</code> parameter.</li><li>Because <code>3 &gt; 1</code>, <code>foo(2)</code> creates another <em>iterator</em> and passes in <code>2</code> as its <code>val</code> parameter.</li><li>Because <code>2 &gt; 1</code>, <code>foo(1)</code> creates yet another <em>iterator</em> and passes in <code>1</code> as its <code>val</code> parameter.</li><li><code>1 &gt; 1</code> is <code>false</code>, so we next call <code>request(..)</code> with the <code>1</code> value, and get a promise back for that first Ajax call.</li><li>That promise is <code>yield</code>ed out, which comes back to the <code>*foo(2)</code> generator instance.</li><li>The <code>yield *</code> passes that promise back out to the <code>*foo(3)</code> generator instance. Another <code>yield *</code> passes the promise out to the <code>*bar()</code> generator instance. And yet again another <code>yield *</code> passes the promise out to the <code>run(..)</code> utility, which will wait on that promise (for the first Ajax request) to proceed.</li><li>When the promise resolves, its fulfillment message is sent to resume <code>*bar()</code>, which passes through the <code>yield *</code> into the <code>*foo(3)</code> instance, which then passes through the <code>yield *</code> to the <code>*foo(2)</code> generator instance, which then passes through the <code>yield *</code> to the normal <code>yield</code> that&#39;s waiting in the <code>*foo(3)</code> generator instance.</li><li>That first call&#39;s Ajax response is now immediately <code>return</code>ed from the <code>*foo(3)</code> generator instance, which sends that value back as the result of the <code>yield *</code> expression in the <code>*foo(2)</code> instance, and assigned to its local <code>val</code> variable.</li><li>Inside <code>*foo(2)</code>, a second Ajax request is made with <code>request(..)</code>, whose promise is <code>yield</code>ed back to the <code>*foo(1)</code> instance, and then <code>yield *</code> propagates all the way out to <code>run(..)</code> (step 7 again). When the promise resolves, the second Ajax response propagates all the way back into the <code>*foo(2)</code> generator instance, and is assigned to its local <code>val</code> variable.</li><li>Finally, the third Ajax request is made with <code>request(..)</code>, its promise goes out to <code>run(..)</code>, and then its resolution value comes all the way back, which is then <code>return</code>ed so that it comes back to the waiting <code>yield *</code> expression in <code>*bar()</code>.</li></ol><p>Phew! A lot of crazy mental juggling, huh? You might want to read through that a few more times, and then go grab a snack to clear your head!</p><h2 id="generator-concurrency" tabindex="-1"><a class="header-anchor" href="#generator-concurrency" aria-hidden="true">#</a> Generator Concurrency</h2><p>As we discussed in both Chapter 1 and earlier in this chapter, two simultaneously running &quot;processes&quot; can cooperatively interleave their operations, and many times this can <em>yield</em> (pun intended) very powerful asynchrony expressions.</p><p>Frankly, our earlier examples of concurrency interleaving of multiple generators showed how to make it really confusing. But we hinted that there&#39;s places where this capability is quite useful.</p><p>Recall a scenario we looked at in Chapter 1, where two different simultaneous Ajax response handlers needed to coordinate with each other to make sure that the data communication was not a race condition. We slotted the responses into the <code>res</code> array like this:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">response</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>url <span class="token operator">==</span> <span class="token string">&quot;http://some.url.1&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>url <span class="token operator">==</span> <span class="token string">&quot;http://some.url.2&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		res<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>But how can we use multiple generators concurrently for this scenario?</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// \`request(..)\` is a Promise-aware Ajax utility</span>

<span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">reqData</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
		<span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span> url <span class="token punctuation">)</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>Note:</strong> We&#39;re going to use two instances of the <code>*reqData(..)</code> generator here, but there&#39;s no difference to running a single instance of two different generators; both approaches are reasoned about identically. We&#39;ll see two different generators coordinating in just a bit.</p><p>Instead of having to manually sort out <code>res[0]</code> and <code>res[1]</code> assignments, we&#39;ll use coordinated ordering so that <code>res.push(..)</code> properly slots the values in the expected and predictable order. The expressed logic thus should feel a bit cleaner.</p><p>But how will we actually orchestrate this interaction? First, let&#39;s just do it manually, with Promises:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> it1 <span class="token operator">=</span> <span class="token function">reqData</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.1&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> it2 <span class="token operator">=</span> <span class="token function">reqData</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.2&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> p1 <span class="token operator">=</span> it1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
<span class="token keyword">var</span> p2 <span class="token operator">=</span> it2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>

p1
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	it1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> data <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> p2<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	it2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> data <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><code>*reqData(..)</code>&#39;s two instances are both started to make their Ajax requests, then paused with <code>yield</code>. Then we choose to resume the first instance when <code>p1</code> resolves, and then <code>p2</code>&#39;s resolution will restart the second instance. In this way, we use Promise orchestration to ensure that <code>res[0]</code> will have the first response and <code>res[1]</code> will have the second response.</p><p>But frankly, this is awfully manual, and it doesn&#39;t really let the generators orchestrate themselves, which is where the true power can lie. Let&#39;s try it a different way:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// \`request(..)\` is a Promise-aware Ajax utility</span>

<span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">reqData</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span> url <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// transfer control</span>
	<span class="token keyword">yield</span><span class="token punctuation">;</span>

	res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> data <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> it1 <span class="token operator">=</span> <span class="token function">reqData</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.1&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> it2 <span class="token operator">=</span> <span class="token function">reqData</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.2&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> p1 <span class="token operator">=</span> it1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
<span class="token keyword">var</span> p2 <span class="token operator">=</span> it2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>

p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	it1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> data <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

p2<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	it2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span> data <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span> <span class="token punctuation">[</span>p1<span class="token punctuation">,</span>p2<span class="token punctuation">]</span> <span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	it1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	it2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>OK, this is a bit better (though still manual!), because now the two instances of <code>*reqData(..)</code> run truly concurrently, and (at least for the first part) independently.</p><p>In the previous snippet, the second instance was not given its data until after the first instance was totally finished. But here, both instances receive their data as soon as their respective responses come back, and then each instance does another <code>yield</code> for control transfer purposes. We then choose what order to resume them in the <code>Promise.all([ .. ])</code> handler.</p><p>What may not be as obvious is that this approach hints at an easier form for a reusable utility, because of the symmetry. We can do even better. Let&#39;s imagine using a utility called <code>runAll(..)</code>:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// \`request(..)\` is a Promise-aware Ajax utility</span>

<span class="token keyword">var</span> res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token function">runAll</span><span class="token punctuation">(</span>
	<span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">var</span> p1 <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.1&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// transfer control</span>
		<span class="token keyword">yield</span><span class="token punctuation">;</span>

		res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token keyword">yield</span> p1 <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.2&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// transfer control</span>
		<span class="token keyword">yield</span><span class="token punctuation">;</span>

		res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token keyword">yield</span> p2 <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p><strong>Note:</strong> We&#39;re not including a code listing for <code>runAll(..)</code> as it is not only long enough to bog down the text, but is an extension of the logic we&#39;ve already implemented in <code>run(..)</code> earlier. So, as a good supplementary exercise for the reader, try your hand at evolving the code from <code>run(..)</code> to work like the imagined <code>runAll(..)</code>. Also, my <em>asynquence</em> library provides a previously mentioned <code>runner(..)</code> utility with this kind of capability already built in, and will be discussed in Appendix A of this book.</p><p>Here&#39;s how the processing inside <code>runAll(..)</code> would operate:</p><ol><li>The first generator gets a promise for the first Ajax response from <code>&quot;http://some.url.1&quot;</code>, then <code>yield</code>s control back to the <code>runAll(..)</code> utility.</li><li>The second generator runs and does the same for <code>&quot;http://some.url.2&quot;</code>, <code>yield</code>ing control back to the <code>runAll(..)</code> utility.</li><li>The first generator resumes, and then <code>yield</code>s out its promise <code>p1</code>. The <code>runAll(..)</code> utility does the same in this case as our previous <code>run(..)</code>, in that it waits on that promise to resolve, then resumes the same generator (no control transfer!). When <code>p1</code> resolves, <code>runAll(..)</code> resumes the first generator again with that resolution value, and then <code>res[0]</code> is given its value. When the first generator then finishes, that&#39;s an implicit transfer of control.</li><li>The second generator resumes, <code>yield</code>s out its promise <code>p2</code>, and waits for it to resolve. Once it does, <code>runAll(..)</code> resumes the second generator with that value, and <code>res[1]</code> is set.</li></ol><p>In this running example, we use an outer variable called <code>res</code> to store the results of the two different Ajax responses -- that&#39;s our concurrency coordination making that possible.</p><p>But it might be quite helpful to further extend <code>runAll(..)</code> to provide an inner variable space for the multiple generator instances to <em>share</em>, such as an empty object we&#39;ll call <code>data</code> below. Also, it could take non-Promise values that are <code>yield</code>ed and hand them off to the next generator.</p><p>Consider:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// \`request(..)\` is a Promise-aware Ajax utility</span>

<span class="token function">runAll</span><span class="token punctuation">(</span>
	<span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
		data<span class="token punctuation">.</span>res <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token comment">// transfer control (and message pass)</span>
		<span class="token keyword">var</span> url1 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token string">&quot;http://some.url.2&quot;</span><span class="token punctuation">;</span>

		<span class="token keyword">var</span> p1 <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span> url1 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;http://some.url.1&quot;</span>

		<span class="token comment">// transfer control</span>
		<span class="token keyword">yield</span><span class="token punctuation">;</span>

		data<span class="token punctuation">.</span>res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token keyword">yield</span> p1 <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// transfer control (and message pass)</span>
		<span class="token keyword">var</span> url2 <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token string">&quot;http://some.url.1&quot;</span><span class="token punctuation">;</span>

		<span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span> url2 <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;http://some.url.2&quot;</span>

		<span class="token comment">// transfer control</span>
		<span class="token keyword">yield</span><span class="token punctuation">;</span>

		data<span class="token punctuation">.</span>res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token keyword">yield</span> p2 <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>In this formulation, the two generators are not just coordinating control transfer, but actually communicating with each other, both through <code>data.res</code> and the <code>yield</code>ed messages that trade <code>url1</code> and <code>url2</code> values. That&#39;s incredibly powerful!</p><p>Such realization also serves as a conceptual base for a more sophisticated asynchrony technique called CSP (Communicating Sequential Processes), which we will cover in Appendix B of this book.</p><h2 id="thunks" tabindex="-1"><a class="header-anchor" href="#thunks" aria-hidden="true">#</a> Thunks</h2><p>So far, we&#39;ve made the assumption that <code>yield</code>ing a Promise from a generator -- and having that Promise resume the generator via a helper utility like <code>run(..)</code> -- was the best possible way to manage asynchrony with generators. To be clear, it is.</p><p>But we skipped over another pattern that has some mildly widespread adoption, so in the interest of completeness we&#39;ll take a brief look at it.</p><p>In general computer science, there&#39;s an old pre-JS concept called a &quot;thunk.&quot; Without getting bogged down in the historical nature, a narrow expression of a thunk in JS is a function that -- without any parameters -- is wired to call another function.</p><p>In other words, you wrap a function definition around function call -- with any parameters it needs -- to <em>defer</em> the execution of that call, and that wrapping function is a thunk. When you later execute the thunk, you end up calling the original function.</p><p>For example:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span>y</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">fooThunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">foo</span><span class="token punctuation">(</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// later</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token function">fooThunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 7</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>So, a synchronous thunk is pretty straightforward. But what about an async thunk? We can essentially extend the narrow thunk definition to include it receiving a callback.</p><p>Consider:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token function">cb</span><span class="token punctuation">(</span> x <span class="token operator">+</span> y <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">fooThunk</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">foo</span><span class="token punctuation">(</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> cb <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// later</span>

<span class="token function">fooThunk</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sum</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> sum <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 7</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>As you can see, <code>fooThunk(..)</code> only expects a <code>cb(..)</code> parameter, as it already has values <code>3</code> and <code>4</code> (for <code>x</code> and <code>y</code>, respectively) pre-specified and ready to pass to <code>foo(..)</code>. A thunk is just waiting around patiently for the last piece it needs to do its job: the callback.</p><p>You don&#39;t want to make thunks manually, though. So, let&#39;s invent a utility that does this wrapping for us.</p><p>Consider:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">thunkify</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> arguments<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> cb <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span> <span class="token keyword">null</span><span class="token punctuation">,</span> args <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> fooThunk <span class="token operator">=</span> <span class="token function">thunkify</span><span class="token punctuation">(</span> foo<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// later</span>

<span class="token function">fooThunk</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sum</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> sum <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 7</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>Tip:</strong> Here we assume that the original (<code>foo(..)</code>) function signature expects its callback in the last position, with any other parameters coming before it. This is a pretty ubiquitous &quot;standard&quot; for async JS function standards. You might call it &quot;callback-last style.&quot; If for some reason you had a need to handle &quot;callback-first style&quot; signatures, you would just make a utility that used <code>args.unshift(..)</code> instead of <code>args.push(..)</code>.</p><p>The preceding formulation of <code>thunkify(..)</code> takes both the <code>foo(..)</code> function reference, and any parameters it needs, and returns back the thunk itself (<code>fooThunk(..)</code>). However, that&#39;s not the typical approach you&#39;ll find to thunks in JS.</p><p>Instead of <code>thunkify(..)</code> making the thunk itself, typically -- if not perplexingly -- the <code>thunkify(..)</code> utility would produce a function that produces thunks.</p><p>Uhhhh... yeah.</p><p>Consider:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">thunkify</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span> arguments <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> cb <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span> <span class="token keyword">null</span><span class="token punctuation">,</span> args <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>The main difference here is the extra <code>return function() { .. }</code> layer. Here&#39;s how its usage differs:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> whatIsThis <span class="token operator">=</span> <span class="token function">thunkify</span><span class="token punctuation">(</span> foo <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> fooThunk <span class="token operator">=</span> <span class="token function">whatIsThis</span><span class="token punctuation">(</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// later</span>

<span class="token function">fooThunk</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sum</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> sum <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 7</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>Obviously, the big question this snippet implies is what is <code>whatIsThis</code> properly called? It&#39;s not the thunk, it&#39;s the thing that will produce thunks from <code>foo(..)</code> calls. It&#39;s kind of like a &quot;factory&quot; for &quot;thunks.&quot; There doesn&#39;t seem to be any kind of standard agreement for naming such a thing.</p><p>So, my proposal is &quot;thunkory&quot; (&quot;thunk&quot; + &quot;factory&quot;). So, <code>thunkify(..)</code> produces a thunkory, and a thunkory produces thunks. That reasoning is symmetric to my proposal for &quot;promisory&quot; in Chapter 3:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> fooThunkory <span class="token operator">=</span> <span class="token function">thunkify</span><span class="token punctuation">(</span> foo <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> fooThunk1 <span class="token operator">=</span> <span class="token function">fooThunkory</span><span class="token punctuation">(</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> fooThunk2 <span class="token operator">=</span> <span class="token function">fooThunkory</span><span class="token punctuation">(</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// later</span>

<span class="token function">fooThunk1</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sum</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> sum <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 7</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">fooThunk2</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sum</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> sum <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 11</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><strong>Note:</strong> The running <code>foo(..)</code> example expects a style of callback that&#39;s not &quot;error-first style.&quot; Of course, &quot;error-first style&quot; is much more common. If <code>foo(..)</code> had some sort of legitimate error-producing expectation, we could change it to expect and use an error-first callback. None of the subsequent <code>thunkify(..)</code> machinery cares what style of callback is assumed. The only difference in usage would be <code>fooThunk1(function(err,sum){..</code>.</p><p>Exposing the thunkory method -- instead of how the earlier <code>thunkify(..)</code> hides this intermediary step -- may seem like unnecessary complication. But in general, it&#39;s quite useful to make thunkories at the beginning of your program to wrap existing API methods, and then be able to pass around and call those thunkories when you need thunks. The two distinct steps preserve a cleaner separation of capability.</p><p>To illustrate:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// cleaner:</span>
<span class="token keyword">var</span> fooThunkory <span class="token operator">=</span> <span class="token function">thunkify</span><span class="token punctuation">(</span> foo <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> fooThunk1 <span class="token operator">=</span> <span class="token function">fooThunkory</span><span class="token punctuation">(</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> fooThunk2 <span class="token operator">=</span> <span class="token function">fooThunkory</span><span class="token punctuation">(</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// instead of:</span>
<span class="token keyword">var</span> fooThunk1 <span class="token operator">=</span> <span class="token function">thunkify</span><span class="token punctuation">(</span> foo<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> fooThunk2 <span class="token operator">=</span> <span class="token function">thunkify</span><span class="token punctuation">(</span> foo<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>Regardless of whether you like to deal with the thunkories explicitly or not, the usage of thunks <code>fooThunk1(..)</code> and <code>fooThunk2(..)</code> remains the same.</p><h3 id="s-promise-thunk" tabindex="-1"><a class="header-anchor" href="#s-promise-thunk" aria-hidden="true">#</a> s/promise/thunk/</h3><p>So what&#39;s all this thunk stuff have to do with generators?</p><p>Comparing thunks to promises generally: they&#39;re not directly interchangable as they&#39;re not equivalent in behavior. Promises are vastly more capable and trustable than bare thunks.</p><p>But in another sense, they both can be seen as a request for a value, which may be async in its answering.</p><p>Recall from Chapter 3 we defined a utility for promisifying a function, which we called <code>Promise.wrap(..)</code> -- we could have called it <code>promisify(..)</code>, too! This Promise-wrapping utility doesn&#39;t produce Promises; it produces promisories that in turn produce Promises. This is completely symmetric to the thunkories and thunks presently being discussed.</p><p>To illustrate the symmetry, let&#39;s first alter the running <code>foo(..)</code> example from earlier to assume an &quot;error-first style&quot; callback:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">setTimeout</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// assume \`cb(..)\` as &quot;error-first style&quot;</span>
		<span class="token function">cb</span><span class="token punctuation">(</span> <span class="token keyword">null</span><span class="token punctuation">,</span> x <span class="token operator">+</span> y <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Now, we&#39;ll compare using <code>thunkify(..)</code> and <code>promisify(..)</code> (aka <code>Promise.wrap(..)</code> from Chapter 3):</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// symmetrical: constructing the question asker</span>
<span class="token keyword">var</span> fooThunkory <span class="token operator">=</span> <span class="token function">thunkify</span><span class="token punctuation">(</span> foo <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> fooPromisory <span class="token operator">=</span> <span class="token function">promisify</span><span class="token punctuation">(</span> foo <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// symmetrical: asking the question</span>
<span class="token keyword">var</span> fooThunk <span class="token operator">=</span> <span class="token function">fooThunkory</span><span class="token punctuation">(</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> fooPromise <span class="token operator">=</span> <span class="token function">fooPromisory</span><span class="token punctuation">(</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// get the thunk answer</span>
<span class="token function">fooThunk</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>sum</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> sum <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 7</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// get the promise answer</span>
fooPromise
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
	<span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sum</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> sum <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 7</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>Both the thunkory and the promisory are essentially asking a question (for a value), and respectively the thunk <code>fooThunk</code> and promise <code>fooPromise</code> represent the future answers to that question. Presented in that light, the symmetry is clear.</p><p>With that perspective in mind, we can see that generators which <code>yield</code> Promises for asynchrony could instead <code>yield</code> thunks for asynchrony. All we&#39;d need is a smarter <code>run(..)</code> utility (like from before) that can not only look for and wire up to a <code>yield</code>ed Promise but also to provide a callback to a <code>yield</code>ed thunk.</p><p>Consider:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> val <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.1&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> val <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span> foo <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>In this example, <code>request(..)</code> could either be a promisory that returns a promise, or a thunkory that returns a thunk. From the perspective of what&#39;s going on inside the generator code logic, we don&#39;t care about that implementation detail, which is quite powerful!</p><p>So, <code>request(..)</code> could be either:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// promisory \`request(..)\` (see Chapter 3)</span>
<span class="token keyword">var</span> request <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span> ajax <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// vs.</span>

<span class="token comment">// thunkory \`request(..)\`</span>
<span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token function">thunkify</span><span class="token punctuation">(</span> ajax <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Finally, as a thunk-aware patch to our earlier <code>run(..)</code> utility, we would need logic like this:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// ..</span>
<span class="token comment">// did we receive a thunk back?</span>
<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> next<span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// call the thunk with an error-first callback</span>
		next<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">reject</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token function">resolve</span><span class="token punctuation">(</span> msg <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
		handleNext<span class="token punctuation">,</span>
		<span class="token keyword">function</span> <span class="token function">handleErr</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>
				it<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span> err <span class="token punctuation">)</span>
			<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> handleResult <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>Now, our generators can either call promisories to <code>yield</code> Promises, or call thunkories to <code>yield</code> thunks, and in either case, <code>run(..)</code> would handle that value and use it to wait for the completion to resume the generator.</p><p>Symmetry wise, these two approaches look identical. However, we should point out that&#39;s true only from the perspective of Promises or thunks representing the future value continuation of a generator.</p><p>From the larger perspective, thunks do not in and of themselves have hardly any of the trustability or composability guarantees that Promises are designed with. Using a thunk as a stand-in for a Promise in this particular generator asynchrony pattern is workable but should be seen as less than ideal when compared to all the benefits that Promises offer (see Chapter 3).</p><p>If you have the option, prefer <code>yield pr</code> rather than <code>yield th</code>. But there&#39;s nothing wrong with having a <code>run(..)</code> utility which can handle both value types.</p><p><strong>Note:</strong> The <code>runner(..)</code> utility in my <em>asynquence</em> library, which will be discussed in Appendix A, handles <code>yield</code>s of Promises, thunks and <em>asynquence</em> sequences.</p><h2 id="pre-es6-generators" tabindex="-1"><a class="header-anchor" href="#pre-es6-generators" aria-hidden="true">#</a> Pre-ES6 Generators</h2><p>You&#39;re hopefully convinced now that generators are a very important addition to the async programming toolbox. But it&#39;s a new syntax in ES6, which means you can&#39;t just polyfill generators like you can Promises (which are just a new API). So what can we do to bring generators to our browser JS if we don&#39;t have the luxury of ignoring pre-ES6 browsers?</p><p>For all new syntax extensions in ES6, there are tools -- the most common term for them is transpilers, for trans-compilers -- which can take your ES6 syntax and transform it into equivalent (but obviously uglier!) pre-ES6 code. So, generators can be transpiled into code that will have the same behavior but work in ES5 and below.</p><p>But how? The &quot;magic&quot; of <code>yield</code> doesn&#39;t obviously sound like code that&#39;s easy to transpile. We actually hinted at a solution in our earlier discussion of closure-based <em>iterators</em>.</p><h3 id="manual-transformation" tabindex="-1"><a class="header-anchor" href="#manual-transformation" aria-hidden="true">#</a> Manual Transformation</h3><p>Before we discuss the transpilers, let&#39;s derive how manual transpilation would work in the case of generators. This isn&#39;t just an academic exercise, because doing so will actually help further reinforce how they work.</p><p>Consider:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// \`request(..)\` is a Promise-aware Ajax utility</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;requesting:&quot;</span><span class="token punctuation">,</span> url <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">var</span> val <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">request</span><span class="token punctuation">(</span> url <span class="token punctuation">)</span><span class="token punctuation">;</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> val <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;Oops:&quot;</span><span class="token punctuation">,</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.1&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>The first thing to observe is that we&#39;ll still need a normal <code>foo()</code> function that can be called, and it will still need to return an <em>iterator</em>. So, let&#39;s sketch out the non-generator transformation:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token comment">// ..</span>

	<span class="token comment">// make and return an iterator</span>
	<span class="token keyword">return</span> <span class="token punctuation">{</span>
		<span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// ..</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token function-variable function">throw</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// ..</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> it <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span> <span class="token string">&quot;http://some.url.1&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>The next thing to observe is that a generator does its &quot;magic&quot; by suspending its scope/state, but we can emulate that with function closure (see the <em>Scope &amp; Closures</em> title of this series). To understand how to write such code, we&#39;ll first annotate different parts of our generator with state values:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// \`request(..)\` is a Promise-aware Ajax utility</span>

<span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// STATE *1*</span>

	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;requesting:&quot;</span><span class="token punctuation">,</span> url <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">var</span> <span class="token constant">TMP1</span> <span class="token operator">=</span> <span class="token function">request</span><span class="token punctuation">(</span> url <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// STATE *2*</span>
		<span class="token keyword">var</span> val <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token constant">TMP1</span><span class="token punctuation">;</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> val <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// STATE *3*</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;Oops:&quot;</span><span class="token punctuation">,</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><strong>Note:</strong> For more accurate illustration, we split up the <code>val = yield request..</code> statement into two parts, using the temporary <code>TMP1</code> variable. <code>request(..)</code> happens in state <code>*1*</code>, and the assignment of its completion value to <code>val</code> happens in state <code>*2*</code>. We&#39;ll get rid of that intermediate <code>TMP1</code> when we convert the code to its non-generator equivalent.</p><p>In other words, <code>*1*</code> is the beginning state, <code>*2*</code> is the state if the <code>request(..)</code> succeeds, and <code>*3*</code> is the state if the <code>request(..)</code> fails. You can probably imagine how any extra <code>yield</code> steps would just be encoded as extra states.</p><p>Back to our transpiled generator, let&#39;s define a variable <code>state</code> in the closure we can use to keep track of the state:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// manage generator state</span>
	<span class="token keyword">var</span> state<span class="token punctuation">;</span>

	<span class="token comment">// ..</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Now, let&#39;s define an inner function called <code>process(..)</code> inside the closure which handles each state, using a <code>switch</code> statement:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// \`request(..)\` is a Promise-aware Ajax utility</span>

<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// manage generator state</span>
	<span class="token keyword">var</span> state<span class="token punctuation">;</span>

	<span class="token comment">// generator-wide variable declarations</span>
	<span class="token keyword">var</span> val<span class="token punctuation">;</span>

	<span class="token keyword">function</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;requesting:&quot;</span><span class="token punctuation">,</span> url <span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span> url <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
				val <span class="token operator">=</span> v<span class="token punctuation">;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> val <span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
				<span class="token keyword">var</span> err <span class="token operator">=</span> v<span class="token punctuation">;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;Oops:&quot;</span><span class="token punctuation">,</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// ..</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>Each state in our generator is represented by its own <code>case</code> in the <code>switch</code> statement. <code>process(..)</code> will be called each time we need to process a new state. We&#39;ll come back to how that works in just a moment.</p><p>For any generator-wide variable declarations (<code>val</code>), we move those to a <code>var</code> declaration outside of <code>process(..)</code> so they can survive multiple calls to <code>process(..)</code>. But the &quot;block scoped&quot; <code>err</code> variable is only needed for the <code>*3*</code> state, so we leave it in place.</p><p>In state <code>*1*</code>, instead of <code>yield request(..)</code>, we did <code>return request(..)</code>. In terminal state <code>*2*</code>, there was no explicit <code>return</code>, so we just do a <code>return;</code> which is the same as <code>return undefined</code>. In terminal state <code>*3*</code>, there was a <code>return false</code>, so we preserve that.</p><p>Now we need to define the code in the <em>iterator</em> functions so they call <code>process(..)</code> appropriately:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// manage generator state</span>
	<span class="token keyword">var</span> state<span class="token punctuation">;</span>

	<span class="token comment">// generator-wide variable declarations</span>
	<span class="token keyword">var</span> val<span class="token punctuation">;</span>

	<span class="token keyword">function</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;requesting:&quot;</span><span class="token punctuation">,</span> url <span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span> url <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
				val <span class="token operator">=</span> v<span class="token punctuation">;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> val <span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
				<span class="token keyword">var</span> err <span class="token operator">=</span> v<span class="token punctuation">;</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;Oops:&quot;</span><span class="token punctuation">,</span> err <span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// make and return an iterator</span>
	<span class="token keyword">return</span> <span class="token punctuation">{</span>
		<span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// initial state</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				state <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token punctuation">{</span>
					<span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
					<span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// yield resumed successfully</span>
			<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				state <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token punctuation">{</span>
					<span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
					<span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token function">process</span><span class="token punctuation">(</span> v <span class="token punctuation">)</span>
				<span class="token punctuation">}</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// generator already completed</span>
			<span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token punctuation">{</span>
					<span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
					<span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token keyword">undefined</span>
				<span class="token punctuation">}</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token string-property property">&quot;throw&quot;</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// the only explicit error handling is in</span>
			<span class="token comment">// state *1*</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				state <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token punctuation">{</span>
					<span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
					<span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token function">process</span><span class="token punctuation">(</span> e <span class="token punctuation">)</span>
				<span class="token punctuation">}</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// otherwise, an error won&#39;t be handled,</span>
			<span class="token comment">// so just throw it right back out</span>
			<span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token keyword">throw</span> e<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><p>How does this code work?</p><ol><li>The first call to the <em>iterator</em>&#39;s <code>next()</code> call would move the generator from the uninitialized state to state <code>1</code>, and then call <code>process()</code> to handle that state. The return value from <code>request(..)</code>, which is the promise for the Ajax response, is returned back as the <code>value</code> property from the <code>next()</code> call.</li><li>If the Ajax request succeeds, the second call to <code>next(..)</code> should send in the Ajax response value, which moves our state to <code>2</code>. <code>process(..)</code> is again called (this time with the passed in Ajax response value), and the <code>value</code> property returned from <code>next(..)</code> will be <code>undefined</code>.</li><li>However, if the Ajax request fails, <code>throw(..)</code> should be called with the error, which would move the state from <code>1</code> to <code>3</code> (instead of <code>2</code>). Again <code>process(..)</code> is called, this time with the error value. That <code>case</code> returns <code>false</code>, which is set as the <code>value</code> property returned from the <code>throw(..)</code> call.</li></ol><p>From the outside -- that is, interacting only with the <em>iterator</em> -- this <code>foo(..)</code> normal function works pretty much the same as the <code>*foo(..)</code> generator would have worked. So we&#39;ve effectively &quot;transpiled&quot; our ES6 generator to pre-ES6 compatibility!</p><p>We could then manually instantiate our generator and control its iterator -- calling <code>var it = foo(&quot;..&quot;)</code> and <code>it.next(..)</code> and such -- or better, we could pass it to our previously defined <code>run(..)</code> utility as <code>run(foo,&quot;..&quot;)</code>.</p><h3 id="automatic-transpilation" tabindex="-1"><a class="header-anchor" href="#automatic-transpilation" aria-hidden="true">#</a> Automatic Transpilation</h3><p>The preceding exercise of manually deriving a transformation of our ES6 generator to pre-ES6 equivalent teaches us how generators work conceptually. But that transformation was really intricate and very non-portable to other generators in our code. It would be quite impractical to do this work by hand, and would completely obviate all the benefit of generators.</p><p>But luckily, several tools already exist that can automatically convert ES6 generators to things like what we derived in the previous section. Not only do they do the heavy lifting work for us, but they also handle several complications that we glossed over.</p><p>One such tool is regenerator (https://facebook.github.io/regenerator/), from the smart folks at Facebook.</p><p>If we use regenerator to transpile our previous generator, here&#39;s the code produced (at the time of this writing):</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// \`request(..)\` is a Promise-aware Ajax utility</span>

<span class="token keyword">var</span> foo <span class="token operator">=</span> regeneratorRuntime<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> val<span class="token punctuation">;</span>

    <span class="token keyword">return</span> regeneratorRuntime<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">foo$</span><span class="token punctuation">(</span><span class="token parameter">context$1$0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">switch</span> <span class="token punctuation">(</span>context$1$0<span class="token punctuation">.</span>prev <span class="token operator">=</span> context$1$0<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
            context$1$0<span class="token punctuation">.</span>prev <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> <span class="token string">&quot;requesting:&quot;</span><span class="token punctuation">,</span> url <span class="token punctuation">)</span><span class="token punctuation">;</span>
            context$1$0<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">request</span><span class="token punctuation">(</span> url <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
            val <span class="token operator">=</span> context$1$0<span class="token punctuation">.</span>sent<span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> val <span class="token punctuation">)</span><span class="token punctuation">;</span>
            context$1$0<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">8</span><span class="token operator">:</span>
            context$1$0<span class="token punctuation">.</span>prev <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
            context$1$0<span class="token punctuation">.</span>t0 <span class="token operator">=</span> context$1$0<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Oops:&quot;</span><span class="token punctuation">,</span> context$1$0<span class="token punctuation">.</span>t0<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> context$1$0<span class="token punctuation">.</span><span class="token function">abrupt</span><span class="token punctuation">(</span><span class="token string">&quot;return&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">12</span><span class="token operator">:</span>
        <span class="token keyword">case</span> <span class="token string">&quot;end&quot;</span><span class="token operator">:</span>
            <span class="token keyword">return</span> context$1$0<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> foo<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>There&#39;s some obvious similarities here to our manual derivation, such as the <code>switch</code> / <code>case</code> statements, and we even see <code>val</code> pulled out of the closure just as we did.</p><p>Of course, one trade-off is that regenerator&#39;s transpilation requires a helper library <code>regeneratorRuntime</code> that holds all the reusable logic for managing a general generator / <em>iterator</em>. A lot of that boilerplate looks different than our version, but even then, the concepts can be seen, like with <code>context$1$0.next = 4</code> keeping track of the next state for the generator.</p><p>The main takeaway is that generators are not restricted to only being useful in ES6+ environments. Once you understand the concepts, you can employ them throughout your code, and use tools to transform the code to be compatible with older environments.</p><p>This is more work than just using a <code>Promise</code> API polyfill for pre-ES6 Promises, but the effort is totally worth it, because generators are so much better at expressing async flow control in a reason-able, sensible, synchronous-looking, sequential fashion.</p><p>Once you get hooked on generators, you&#39;ll never want to go back to the hell of async spaghetti callbacks!</p><h2 id="review" tabindex="-1"><a class="header-anchor" href="#review" aria-hidden="true">#</a> Review</h2><p>Generators are a new ES6 function type that does not run-to-completion like normal functions. Instead, the generator can be paused in mid-completion (entirely preserving its state), and it can later be resumed from where it left off.</p><p>This pause/resume interchange is cooperative rather than preemptive, which means that the generator has the sole capability to pause itself, using the <code>yield</code> keyword, and yet the <em>iterator</em> that controls the generator has the sole capability (via <code>next(..)</code>) to resume the generator.</p><p>The <code>yield</code> / <code>next(..)</code> duality is not just a control mechanism, it&#39;s actually a two-way message passing mechanism. A <code>yield ..</code> expression essentially pauses waiting for a value, and the next <code>next(..)</code> call passes a value (or implicit <code>undefined</code>) back to that paused <code>yield</code> expression.</p><p>The key benefit of generators related to async flow control is that the code inside a generator expresses a sequence of steps for the task in a naturally sync/sequential fashion. The trick is that we essentially hide potential asynchrony behind the <code>yield</code> keyword -- moving the asynchrony to the code where the generator&#39;s <em>iterator</em> is controlled.</p><p>In other words, generators preserve a sequential, synchronous, blocking code pattern for async code, which lets our brains reason about the code much more naturally, addressing one of the two key drawbacks of callback-based async.</p>`,432);function t(o,p){return e}var l=n(a,[["render",t],["__file","ch4.html.vue"]]);export{l as default};
