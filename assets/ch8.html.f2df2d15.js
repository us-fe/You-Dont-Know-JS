import{_ as n,d as s}from"./app.a957722f.js";const a={},e=s(`<h1 id="you-don-t-know-js-yet-scope-closures-2nd-edition" tabindex="-1"><a class="header-anchor" href="#you-don-t-know-js-yet-scope-closures-2nd-edition" aria-hidden="true">#</a> You Don&#39;t Know JS Yet: Scope &amp; Closures - 2nd Edition</h1><h1 id="chapter-8-the-module-pattern" tabindex="-1"><a class="header-anchor" href="#chapter-8-the-module-pattern" aria-hidden="true">#</a> Chapter 8: The Module Pattern</h1><p>In this chapter, we wrap up the main text of the book by exploring one of the most important code organization patterns in all of programming: the module. As we&#39;ll see, modules are inherently built from what we&#39;ve already covered: the payoff for your efforts in learning lexical scope and closure.</p><p>We&#39;ve examined every angle of lexical scope, from the breadth of the global scope down through nested block scopes, into the intricacies of the variable lifecycle. Then we leveraged lexical scope to understand the full power of closure.</p><p>Take a moment to reflect on how far you&#39;ve come in this journey so far; you&#39;ve taken big steps in getting to know JS more deeply!</p><p>The central theme of this book has been that understanding and mastering scope and closure is key in properly structuring and organizing our code, especially the decisions on where to store information in variables.</p><p>Our goal in this final chapter is to appreciate how modules embody the importance of these topics, elevating them from abstract concepts to concrete, practical improvements in building programs.</p><h2 id="encapsulation-and-least-exposure-pole" tabindex="-1"><a class="header-anchor" href="#encapsulation-and-least-exposure-pole" aria-hidden="true">#</a> Encapsulation and Least Exposure (POLE)</h2><p>Encapsulation is often cited as a principle of object-oriented (OO) programming, but it&#39;s more fundamental and broadly applicable than that. The goal of encapsulation is the bundling or co-location of information (data) and behavior (functions) that together serve a common purpose.</p><p>Independent of any syntax or code mechanisms, the spirit of encapsulation can be realized in something as simple as using separate files to hold bits of the overall program with common purpose. If we bundle everything that powers a list of search results into a single file called &quot;search-list.js&quot;, we&#39;re encapsulating that part of the program.</p><p>The recent trend in modern front-end programming to organize applications around Component architecture pushes encapsulation even further. For many, it feels natural to consolidate everything that constitutes the search results list\u2014even beyond code, including presentational markup and styling\u2014into a single unit of program logic, something tangible we can interact with. And then we label that collection the &quot;SearchList&quot; component.</p><p>Another key goal is the control of visibility of certain aspects of the encapsulated data and functionality. Recall from Chapter 6 the <em>least exposure</em> principle (POLE), which seeks to defensively guard against various <em>dangers</em> of scope over-exposure; these affect both variables and functions. In JS, we most often implement visibility control through the mechanics of lexical scope.</p><p>The idea is to group alike program bits together, and selectively limit programmatic access to the parts we consider <em>private</em> details. What&#39;s not considered <em>private</em> is then marked as <em>public</em>, accessible to the whole program.</p><p>The natural effect of this effort is better code organization. It&#39;s easier to build and maintain software when we know where things are, with clear and obvious boundaries and connection points. It&#39;s also easier to maintain quality if we avoid the pitfalls of over-exposed data and functionality.</p><p>These are some of the main benefits of organizing JS programs into modules.</p><h2 id="what-is-a-module" tabindex="-1"><a class="header-anchor" href="#what-is-a-module" aria-hidden="true">#</a> What Is a Module?</h2><p>A module is a collection of related data and functions (often referred to as methods in this context), characterized by a division between hidden <em>private</em> details and <em>public</em> accessible details, usually called the &quot;public API.&quot;</p><p>A module is also stateful: it maintains some information over time, along with functionality to access and update that information.</p><table><thead><tr><th style="text-align:left;">NOTE:</th></tr></thead><tbody><tr><td style="text-align:left;">A broader concern of the module pattern is fully embracing system-level modularization through loose-coupling and other program architecture techniques. That&#39;s a complex topic well beyond the bounds of our discussion, but is worth further study beyond this book.</td></tr></tbody></table><p>To get a better sense of what a module is, let&#39;s compare some module characteristics to useful code patterns that aren&#39;t quite modules.</p><h3 id="namespaces-stateless-grouping" tabindex="-1"><a class="header-anchor" href="#namespaces-stateless-grouping" aria-hidden="true">#</a> Namespaces (Stateless Grouping)</h3><p>If you group a set of related functions together, without data, then you don&#39;t really have the expected encapsulation a module implies. The better term for this grouping of <em>stateless</em> functions is a namespace:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// namespace, not module</span>
<span class="token keyword">var</span> Utils <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">cancelEvt</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        evt<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        evt<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        evt<span class="token punctuation">.</span><span class="token function">stopImmediatePropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">wait</span><span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">c</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">isValidEmail</span><span class="token punctuation">(</span><span class="token parameter">email</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[^@]+@[^@.]+\\.[^@.]+</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><code>Utils</code> here is a useful collection of utilities, yet they&#39;re all state-independent functions. Gathering functionality together is generally good practice, but that doesn&#39;t make this a module. Rather, we&#39;ve defined a <code>Utils</code> namespace and organized the functions under it.</p><h3 id="data-structures-stateful-grouping" tabindex="-1"><a class="header-anchor" href="#data-structures-stateful-grouping" aria-hidden="true">#</a> Data Structures (Stateful Grouping)</h3><p>Even if you bundle data and stateful functions together, if you&#39;re not limiting the visibility of any of it, then you&#39;re stopping short of the POLE aspect of encapsulation; it&#39;s not particularly helpful to label that a module.</p><p>Consider:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// data structure, not module</span>
<span class="token keyword">var</span> Student <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">records</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Kyle&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">86</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Suzy&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">87</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">112</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Frank&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">75</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Sarah&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">91</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function">getName</span><span class="token punctuation">(</span><span class="token parameter">studentID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> student <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>records<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
            <span class="token parameter">student</span> <span class="token operator">=&gt;</span> student<span class="token punctuation">.</span>id <span class="token operator">==</span> studentID
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> student<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Student<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token number">73</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Suzy</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>Since <code>records</code> is publicly accessible data, not hidden behind a public API, <code>Student</code> here isn&#39;t really a module.</p><p><code>Student</code> does have the data-and-functionality aspect of encapsulation, but not the visibility-control aspect. It&#39;s best to label this an instance of a data structure.</p><h3 id="modules-stateful-access-control" tabindex="-1"><a class="header-anchor" href="#modules-stateful-access-control" aria-hidden="true">#</a> Modules (Stateful Access Control)</h3><p>To embody the full spirit of the module pattern, we not only need grouping and state, but also access control through visibility (private vs. public).</p><p>Let&#39;s turn <code>Student</code> from the previous section into a module. We&#39;ll start with a form I call the &quot;classic module,&quot; which was originally referred to as the &quot;revealing module&quot; when it first emerged in the early 2000s. Consider:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> Student <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">defineStudent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> records <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Kyle&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">86</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Suzy&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">87</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">112</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Frank&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">75</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Sarah&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">91</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> publicAPI <span class="token operator">=</span> <span class="token punctuation">{</span>
        getName
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> publicAPI<span class="token punctuation">;</span>

    <span class="token comment">// ************************</span>

    <span class="token keyword">function</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token parameter">studentID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> student <span class="token operator">=</span> records<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
            <span class="token parameter">student</span> <span class="token operator">=&gt;</span> student<span class="token punctuation">.</span>id <span class="token operator">==</span> studentID
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> student<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Student<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token number">73</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// Suzy</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p><code>Student</code> is now an instance of a module. It features a public API with a single method: <code>getName(..)</code>. This method is able to access the private hidden <code>records</code> data.</p><table><thead><tr><th style="text-align:left;">WARNING:</th></tr></thead><tbody><tr><td style="text-align:left;">I should point out that the explicit student data being hard-coded into this module definition is just for our illustration purposes. A typical module in your program will receive this data from an outside source, typically loaded from databases, JSON data files, Ajax calls, etc. The data is then injected into the module instance typically through method(s) on the module&#39;s public API.</td></tr></tbody></table><p>How does the classic module format work?</p><p>Notice that the instance of the module is created by the <code>defineStudent()</code> IIFE being executed. This IIFE returns an object (named <code>publicAPI</code>) that has a property on it referencing the inner <code>getName(..)</code> function.</p><p>Naming the object <code>publicAPI</code> is stylistic preference on my part. The object can be named whatever you like (JS doesn&#39;t care), or you can just return an object directly without assigning it to any internal named variable. More on this choice in Appendix A.</p><p>From the outside, <code>Student.getName(..)</code> invokes this exposed inner function, which maintains access to the inner <code>records</code> variable via closure.</p><p>You don&#39;t <em>have</em> to return an object with a function as one of its properties. You could just return a function directly, in place of the object. That still satisfies all the core bits of a classic module.</p><p>By virtue of how lexical scope works, defining variables and functions inside your outer module definition function makes everything <em>by default</em> private. Only properties added to the public API object returned from the function will be exported for external public use.</p><p>The use of an IIFE implies that our program only ever needs a single central instance of the module, commonly referred to as a &quot;singleton.&quot; Indeed, this specific example is simple enough that there&#39;s no obvious reason we&#39;d need anything more than just one instance of the <code>Student</code> module.</p><h4 id="module-factory-multiple-instances" tabindex="-1"><a class="header-anchor" href="#module-factory-multiple-instances" aria-hidden="true">#</a> Module Factory (Multiple Instances)</h4><p>But if we did want to define a module that supported multiple instances in our program, we can slightly tweak the code:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// factory function, not singleton IIFE</span>
<span class="token keyword">function</span> <span class="token function">defineStudent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> records <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Kyle&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">86</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Suzy&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">87</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">112</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Frank&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">75</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Sarah&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">91</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> publicAPI <span class="token operator">=</span> <span class="token punctuation">{</span>
        getName
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> publicAPI<span class="token punctuation">;</span>

    <span class="token comment">// ************************</span>

    <span class="token keyword">function</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token parameter">studentID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> student <span class="token operator">=</span> records<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
            <span class="token parameter">student</span> <span class="token operator">=&gt;</span> student<span class="token punctuation">.</span>id <span class="token operator">==</span> studentID
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> student<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> fullTime <span class="token operator">=</span> <span class="token function">defineStudent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fullTime<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token number">73</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// Suzy</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>Rather than specifying <code>defineStudent()</code> as an IIFE, we just define it as a normal standalone function, which is commonly referred to in this context as a &quot;module factory&quot; function.</p><p>We then call the module factory, producing an instance of the module that we label <code>fullTime</code>. This module instance implies a new instance of the inner scope, and thus a new closure that <code>getName(..)</code> holds over <code>records</code>. <code>fullTime.getName(..)</code> now invokes the method on that specific instance.</p><h4 id="classic-module-definition" tabindex="-1"><a class="header-anchor" href="#classic-module-definition" aria-hidden="true">#</a> Classic Module Definition</h4><p>So to clarify what makes something a classic module:</p><ul><li><p>There must be an outer scope, typically from a module factory function running at least once.</p></li><li><p>The module&#39;s inner scope must have at least one piece of hidden information that represents state for the module.</p></li><li><p>The module must return on its public API a reference to at least one function that has closure over the hidden module state (so that this state is actually preserved).</p></li></ul><p>You&#39;ll likely run across other variations on this classic module approach, which we&#39;ll look at in more detail in Appendix A.</p><h2 id="node-commonjs-modules" tabindex="-1"><a class="header-anchor" href="#node-commonjs-modules" aria-hidden="true">#</a> Node CommonJS Modules</h2><p>In Chapter 4, we introduced the CommonJS module format used by Node. Unlike the classic module format described earlier, where you could bundle the module factory or IIFE alongside any other code including other modules, CommonJS modules are file-based; one module per file.</p><p>Let&#39;s tweak our module example to adhere to that format:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>getName <span class="token operator">=</span> getName<span class="token punctuation">;</span>

<span class="token comment">// ************************</span>

<span class="token keyword">var</span> records <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Kyle&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">86</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Suzy&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">87</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">112</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Frank&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">75</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Sarah&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">91</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token parameter">studentID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> student <span class="token operator">=</span> records<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
        <span class="token parameter">student</span> <span class="token operator">=&gt;</span> student<span class="token punctuation">.</span>id <span class="token operator">==</span> studentID
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> student<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>The <code>records</code> and <code>getName</code> identifiers are in the top-level scope of this module, but that&#39;s not the global scope (as explained in Chapter 4). As such, everything here is <em>by default</em> private to the module.</p><p>To expose something on the public API of a CommonJS module, you add a property to the empty object provided as <code>module.exports</code>. In some older legacy code, you may run across references to just a bare <code>exports</code>, but for code clarity you should always fully qualify that reference with the <code>module.</code> prefix.</p><p>For style purposes, I like to put my &quot;exports&quot; at the top and my module implementation at the bottom. But these exports can be placed anywhere. I strongly recommend collecting them all together, either at the top or bottom of your file.</p><p>Some developers have the habit of replacing the default exports object, like this:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// defining a new object for the API</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// ..exports..</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>There are some quirks with this approach, including unexpected behavior if multiple such modules circularly depend on each other. As such, I recommend against replacing the object. If you want to assign multiple exports at once, using object literal style definition, you can do this instead:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span><span class="token punctuation">{</span>
   <span class="token comment">// .. exports ..</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>What&#39;s happening here is defining the <code>{ .. }</code> object literal with your module&#39;s public API specified, and then <code>Object.assign(..)</code> is performing a shallow copy of all those properties onto the existing <code>module.exports</code> object, instead of replacing it This is a nice balance of convenience and safer module behavior.</p><p>To include another module instance into your module/program, use Node&#39;s <code>require(..)</code> method. Assuming this module is located at &quot;/path/to/student.js&quot;, this is how we can access it:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> Student <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;/path/to/student.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Student<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token number">73</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Suzy</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>Student</code> now references the public API of our example module.</p><p>CommonJS modules behave as singleton instances, similar to the IIFE module definition style presented before. No matter how many times you <code>require(..)</code> the same module, you just get additional references to the single shared module instance.</p><p><code>require(..)</code> is an all-or-nothing mechanism; it includes a reference of the entire exposed public API of the module. To effectively access only part of the API, the typical approach looks like this:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> getName <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;/path/to/student.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getName<span class="token punctuation">;</span>

<span class="token comment">// or alternately:</span>

<span class="token keyword">var</span> <span class="token punctuation">{</span> getName <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;/path/to/student.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>Similar to the classic module format, the publicly exported methods of a CommonJS module&#39;s API hold closures over the internal module details. That&#39;s how the module singleton state is maintained across the lifetime of your program.</p><table><thead><tr><th style="text-align:left;">NOTE:</th></tr></thead><tbody><tr><td style="text-align:left;">In Node <code>require(&quot;student&quot;)</code> statements, non-absolute paths (<code>&quot;student&quot;</code>) assume a &quot;.js&quot; file extension and search &quot;node_modules&quot;.</td></tr></tbody></table><h2 id="modern-es-modules-esm" tabindex="-1"><a class="header-anchor" href="#modern-es-modules-esm" aria-hidden="true">#</a> Modern ES Modules (ESM)</h2><p>The ESM format shares several similarities with the CommonJS format. ESM is file-based, and module instances are singletons, with everything private <em>by default</em>. One notable difference is that ESM files are assumed to be strict-mode, without needing a <code>&quot;use strict&quot;</code> pragma at the top. There&#39;s no way to define an ESM as non-strict-mode.</p><p>Instead of <code>module.exports</code> in CommonJS, ESM uses an <code>export</code> keyword to expose something on the public API of the module. The <code>import</code> keyword replaces the <code>require(..)</code> statement. Let&#39;s adjust &quot;students.js&quot; to use the ESM format:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token punctuation">{</span> getName <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// ************************</span>

<span class="token keyword">var</span> records <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Kyle&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">86</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Suzy&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">87</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">112</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Frank&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">75</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Sarah&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">91</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token parameter">studentID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> student <span class="token operator">=</span> records<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
        <span class="token parameter">student</span> <span class="token operator">=&gt;</span> student<span class="token punctuation">.</span>id <span class="token operator">==</span> studentID
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> student<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>The only change here is the <code>export { getName }</code> statement. As before, <code>export</code> statements can appear anywhere throughout the file, though <code>export</code> must be at the top-level scope; it cannot be inside any other block or function.</p><p>ESM offers a fair bit of variation on how the <code>export</code> statements can be specified. For example:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token parameter">studentID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ..</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Even though <code>export</code> appears before the <code>function</code> keyword here, this form is still a <code>function</code> declaration that also happens to be exported. That is, the <code>getName</code> identifier is <em>function hoisted</em> (see Chapter 5), so it&#39;s available throughout the whole scope of the module.</p><p>Another allowed variation:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token parameter">studentID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ..</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>This is a so-called &quot;default export,&quot; which has different semantics from other exports. In essence, a &quot;default export&quot; is a shorthand for consumers of the module when they <code>import</code>, giving them a terser syntax when they only need this single default API member.</p><p>Non-<code>default</code> exports are referred to as &quot;named exports.&quot;</p><p>The <code>import</code> keyword\u2014like <code>export</code>, it must be used only at the top level of an ESM outside of any blocks or functions\u2014also has a number of variations in syntax. The first is referred to as &quot;named import&quot;:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> getName <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;/path/to/students.js&quot;</span><span class="token punctuation">;</span>

<span class="token function">getName</span><span class="token punctuation">(</span><span class="token number">73</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// Suzy</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>As you can see, this form imports only the specifically named public API members from a module (skipping anything not named explicitly), and it adds those identifiers to the top-level scope of the current module. This type of import is a familiar style to those used to package imports in languages like Java.</p><p>Multiple API members can be listed inside the <code>{ .. }</code> set, separated with commas. A named import can also be <em>renamed</em> with the <code>as</code> keyword:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> getName <span class="token keyword">as</span> getStudentName <span class="token punctuation">}</span>
   <span class="token keyword">from</span> <span class="token string">&quot;/path/to/students.js&quot;</span><span class="token punctuation">;</span>

<span class="token function">getStudentName</span><span class="token punctuation">(</span><span class="token number">73</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Suzy</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>If <code>getName</code> is a &quot;default export&quot; of the module, we can import it like this:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> getName <span class="token keyword">from</span> <span class="token string">&quot;/path/to/students.js&quot;</span><span class="token punctuation">;</span>

<span class="token function">getName</span><span class="token punctuation">(</span><span class="token number">73</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// Suzy</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>The only difference here is dropping the <code>{ }</code> around the import binding. If you want to mix a default import with other named imports:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">default</span> <span class="token keyword">as</span> getName<span class="token punctuation">,</span> <span class="token comment">/* .. others .. */</span> <span class="token punctuation">}</span>
   <span class="token keyword">from</span> <span class="token string">&quot;/path/to/students.js&quot;</span><span class="token punctuation">;</span>

<span class="token function">getName</span><span class="token punctuation">(</span><span class="token number">73</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// Suzy</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>By contrast, the other major variation on <code>import</code> is called &quot;namespace import&quot;:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> Student <span class="token keyword">from</span> <span class="token string">&quot;/path/to/students.js&quot;</span><span class="token punctuation">;</span>

Student<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token number">73</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// Suzy</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>As is likely obvious, the <code>*</code> imports everything exported to the API, default and named, and stores it all under the single namespace identifier as specified. This approach most closely matches the form of classic modules for most of JS&#39;s history.</p><table><thead><tr><th style="text-align:left;">NOTE:</th></tr></thead><tbody><tr><td style="text-align:left;">As of the time of this writing, modern browsers have supported ESM for a few years now, but Node&#39;s stable&#39;ish support for ESM is fairly recent, and has been evolving for quite a while. The evolution is likely to continue for another year or more; the introduction of ESM to JS back in ES6 created a number of challenging compatibility concerns for Node&#39;s interop with CommonJS modules. Consult Node&#39;s ESM documentation for all the latest details: https://nodejs.org/api/esm.html</td></tr></tbody></table><h2 id="exit-scope" tabindex="-1"><a class="header-anchor" href="#exit-scope" aria-hidden="true">#</a> Exit Scope</h2><p>Whether you use the classic module format (browser or Node), CommonJS format (in Node), or ESM format (browser or Node), modules are one of the most effective ways to structure and organize your program&#39;s functionality and data.</p><p>The module pattern is the conclusion of our journey in this book of learning how we can use the rules of lexical scope to place variables and functions in proper locations. POLE is the defensive <em>private by default</em> posture we always take, making sure we avoid over-exposure and interact only with the minimal public API surface area necessary.</p><p>And underneath modules, the <em>magic</em> of how all our module state is maintained is closures leveraging the lexical scope system.</p><p>That&#39;s it for the main text. Congratulations on quite a journey so far! As I&#39;ve said numerous times throughout, it&#39;s a really good idea to pause, reflect, and practice what we&#39;ve just discussed.</p><p>When you&#39;re comfortable and ready, check out the appendices, which dig deeper into some of the corners of these topics, and also challenge you with some practice exercises to solidify what you&#39;ve learned.</p>`,103);function t(p,o){return e}var c=n(a,[["render",t],["__file","ch8.html.vue"]]);export{c as default};
