<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.38">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>You Don't Know JS Yet: Scope & Closures - 2nd Edition | US-FE</title><meta name="description" content="US-FE eBoks">
    <link rel="modulepreload" href="/ebooks/assets/app.a957722f.js"><link rel="modulepreload" href="/ebooks/assets/ch7.html.11ece221.js"><link rel="modulepreload" href="/ebooks/assets/ch7.html.10a5fc6e.js">
    <link rel="stylesheet" href="/ebooks/assets/style.6c500c23.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/ebooks/en/" class=""><img class="logo" src="https://vuejs.org/images/logo.png" alt="US-FE"><span class="site-name can-hide">US-FE</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a class="external-link" href="https://us-fe.github.io" rel="noopener noreferrer" target="_blank" aria-label="US-FE"><!--[--><!--]--> US-FE <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/ebooks/" class="router-link-active" aria-label="Home"><!--[--><!--]--> Home <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="You Don&#39;t Know JS"><span class="title">You Don&#39;t Know JS</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="You Don&#39;t Know JS"><span class="title">You Don&#39;t Know JS</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>V1</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/ebooks/en/you-dont-know-js-v1/up-going/" class="" aria-label="Up &amp; Going"><!--[--><!--]--> Up &amp; Going <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ebooks/en/you-dont-know-js-v1/scope-closures/" class="" aria-label="Scope &amp; Closures"><!--[--><!--]--> Scope &amp; Closures <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ebooks/en/you-dont-know-js-v1/this-object-prototypes/" class="" aria-label="This &amp; Object Prototypes"><!--[--><!--]--> This &amp; Object Prototypes <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ebooks/en/you-dont-know-js-v1/types-grammar/" class="" aria-label="Types &amp; Grammar"><!--[--><!--]--> Types &amp; Grammar <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ebooks/en/you-dont-know-js-v1/async-performance/" class="" aria-label="Async &amp; Performance"><!--[--><!--]--> Async &amp; Performance <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ebooks/en/you-dont-know-js-v1/es6-beyond/" class="" aria-label="ES6 &amp; Beyond"><!--[--><!--]--> ES6 &amp; Beyond <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>V2</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/ebooks/en/you-dont-know-js-v2/get-started/" class="" aria-label="Get Started"><!--[--><!--]--> Get Started <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ebooks/en/you-dont-know-js-v2/scope-closures/" class="router-link-active" aria-label="Scope &amp; Closures"><!--[--><!--]--> Scope &amp; Closures <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Professional Javascript for Web Developers V4"><span class="title">Professional Javascript for Web Developers V4</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Professional Javascript for Web Developers V4"><span class="title">Professional Javascript for Web Developers V4</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch1-what-is-javascript" class="" aria-label="Chapter 1: What Is JavaScript?"><!--[--><!--]--> Chapter 1: What Is JavaScript? <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch2-javascript-in-html" class="" aria-label="Chapter 2: JavaScript in HTML"><!--[--><!--]--> Chapter 2: JavaScript in HTML <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch3-language-basics" class="" aria-label="Chapter 3: Language Basics"><!--[--><!--]--> Chapter 3: Language Basics <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch4-variables-scope-and-memory" class="" aria-label="Chapter 4: Variables, Scope, and Memory"><!--[--><!--]--> Chapter 4: Variables, Scope, and Memory <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch5-basic-reference-types" class="" aria-label="Chapter 5: Basic Reference Types"><!--[--><!--]--> Chapter 5: Basic Reference Types <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch6-collection-reference-types" class="" aria-label="Chapter 6: Collection Reference Types"><!--[--><!--]--> Chapter 6: Collection Reference Types <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch7-iterators-and-generators" class="" aria-label="Chapter 7: Iterators and Generators"><!--[--><!--]--> Chapter 7: Iterators and Generators <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch8-objects-classes-and-object-oriented-programming" class="" aria-label="Chapter 8: Objects, Classes, and Object-Oriented Programming"><!--[--><!--]--> Chapter 8: Objects, Classes, and Object-Oriented Programming <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch9-proxies-and-reflect" class="" aria-label="Chapter 9: Proxies and Reflect"><!--[--><!--]--> Chapter 9: Proxies and Reflect <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch10-funtions" class="" aria-label="Chapter 10: Functions"><!--[--><!--]--> Chapter 10: Functions <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch11-promises-and-async-functions" class="" aria-label="Chapter 11: Promises and Async Functions"><!--[--><!--]--> Chapter 11: Promises and Async Functions <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch12-the-browser-object-model" class="" aria-label="Chapter 12: The Browser Object Model"><!--[--><!--]--> Chapter 12: The Browser Object Model <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch13-client-detection" class="" aria-label="Chapter 13: Client Detection"><!--[--><!--]--> Chapter 13: Client Detection <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch14-the-document-object-model" class="" aria-label="Chapter 14: The Document Object Model"><!--[--><!--]--> Chapter 14: The Document Object Model <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch15-dom-extensions" class="" aria-label="Chapter 15: DOM Extensions"><!--[--><!--]--> Chapter 15: DOM Extensions <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch16-dom-levels-2-and-3" class="" aria-label="Chapter 16: DOM Levels 2 and 3"><!--[--><!--]--> Chapter 16: DOM Levels 2 and 3 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch17-events" class="" aria-label="Chapter 17: Events"><!--[--><!--]--> Chapter 17: Events <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch18-animation-and-graphics-with-canvas" class="" aria-label="Chapter 18: Animation and Graphics with Canvas"><!--[--><!--]--> Chapter 18: Animation and Graphics with Canvas <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch19-scripting-forms" class="" aria-label="Chapter 19: Scripting Forms"><!--[--><!--]--> Chapter 19: Scripting Forms <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch20-javascript-apis" class="" aria-label="Chapter 20: JavaScript APIs"><!--[--><!--]--> Chapter 20: JavaScript APIs <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch21-error-handling-and-debugging" class="" aria-label="Chapter 21: Error Handling and Debugging"><!--[--><!--]--> Chapter 21: Error Handling and Debugging <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch22-xml-in-javascript" class="" aria-label="Chapter 22: XML in JavaScript"><!--[--><!--]--> Chapter 22: XML in JavaScript <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch23-json" class="" aria-label="Chapter 23: JSON"><!--[--><!--]--> Chapter 23: JSON <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch24-network-requests-and-remote-resources" class="" aria-label="Chapter 24: Network Requests and Remote Resources"><!--[--><!--]--> Chapter 24: Network Requests and Remote Resources <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch25-client-side-storage" class="" aria-label="Chapter 25: Client-Side Storage"><!--[--><!--]--> Chapter 25: Client-Side Storage <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch26-modules" class="" aria-label="Chapter 26: Modules"><!--[--><!--]--> Chapter 26: Modules <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch27-workers" class="" aria-label="Chapter 27: Workers"><!--[--><!--]--> Chapter 27: Workers <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch28-best-practices" class="" aria-label="Chapter 28: Best Practices"><!--[--><!--]--> Chapter 28: Best Practices <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/apA-es2018-and-es2019" class="" aria-label="Appendix A: ES2018 and ES2019"><!--[--><!--]--> Appendix A: ES2018 and ES2019 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/apB-strct-mode" class="" aria-label="Appendix B: Strict Mode"><!--[--><!--]--> Appendix B: Strict Mode <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/apC-javascript-libraries-and-frameworks" class="" aria-label="Appendix C: JavaScript Libraries and Frameworks"><!--[--><!--]--> Appendix C: JavaScript Libraries and Frameworks <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/apD-javascript-tools" class="" aria-label="Appendix D: JavasScript Tools"><!--[--><!--]--> Appendix D: JavasScript Tools <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">Languages</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/ebooks/zh/you-dont-know-js-v2/scope-closures/ch7.html" class="" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a aria-current="page" href="/ebooks/en/you-dont-know-js-v2/scope-closures/ch7.html" class="router-link-active router-link-exact-active router-link-active" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/us-fe/ebooks" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a class="external-link" href="https://us-fe.github.io" rel="noopener noreferrer" target="_blank" aria-label="US-FE"><!--[--><!--]--> US-FE <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/ebooks/" class="router-link-active" aria-label="Home"><!--[--><!--]--> Home <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="You Don&#39;t Know JS"><span class="title">You Don&#39;t Know JS</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="You Don&#39;t Know JS"><span class="title">You Don&#39;t Know JS</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>V1</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/ebooks/en/you-dont-know-js-v1/up-going/" class="" aria-label="Up &amp; Going"><!--[--><!--]--> Up &amp; Going <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ebooks/en/you-dont-know-js-v1/scope-closures/" class="" aria-label="Scope &amp; Closures"><!--[--><!--]--> Scope &amp; Closures <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ebooks/en/you-dont-know-js-v1/this-object-prototypes/" class="" aria-label="This &amp; Object Prototypes"><!--[--><!--]--> This &amp; Object Prototypes <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ebooks/en/you-dont-know-js-v1/types-grammar/" class="" aria-label="Types &amp; Grammar"><!--[--><!--]--> Types &amp; Grammar <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ebooks/en/you-dont-know-js-v1/async-performance/" class="" aria-label="Async &amp; Performance"><!--[--><!--]--> Async &amp; Performance <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ebooks/en/you-dont-know-js-v1/es6-beyond/" class="" aria-label="ES6 &amp; Beyond"><!--[--><!--]--> ES6 &amp; Beyond <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>V2</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/ebooks/en/you-dont-know-js-v2/get-started/" class="" aria-label="Get Started"><!--[--><!--]--> Get Started <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ebooks/en/you-dont-know-js-v2/scope-closures/" class="router-link-active" aria-label="Scope &amp; Closures"><!--[--><!--]--> Scope &amp; Closures <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Professional Javascript for Web Developers V4"><span class="title">Professional Javascript for Web Developers V4</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Professional Javascript for Web Developers V4"><span class="title">Professional Javascript for Web Developers V4</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch1-what-is-javascript" class="" aria-label="Chapter 1: What Is JavaScript?"><!--[--><!--]--> Chapter 1: What Is JavaScript? <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch2-javascript-in-html" class="" aria-label="Chapter 2: JavaScript in HTML"><!--[--><!--]--> Chapter 2: JavaScript in HTML <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch3-language-basics" class="" aria-label="Chapter 3: Language Basics"><!--[--><!--]--> Chapter 3: Language Basics <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch4-variables-scope-and-memory" class="" aria-label="Chapter 4: Variables, Scope, and Memory"><!--[--><!--]--> Chapter 4: Variables, Scope, and Memory <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch5-basic-reference-types" class="" aria-label="Chapter 5: Basic Reference Types"><!--[--><!--]--> Chapter 5: Basic Reference Types <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch6-collection-reference-types" class="" aria-label="Chapter 6: Collection Reference Types"><!--[--><!--]--> Chapter 6: Collection Reference Types <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch7-iterators-and-generators" class="" aria-label="Chapter 7: Iterators and Generators"><!--[--><!--]--> Chapter 7: Iterators and Generators <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch8-objects-classes-and-object-oriented-programming" class="" aria-label="Chapter 8: Objects, Classes, and Object-Oriented Programming"><!--[--><!--]--> Chapter 8: Objects, Classes, and Object-Oriented Programming <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch9-proxies-and-reflect" class="" aria-label="Chapter 9: Proxies and Reflect"><!--[--><!--]--> Chapter 9: Proxies and Reflect <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch10-funtions" class="" aria-label="Chapter 10: Functions"><!--[--><!--]--> Chapter 10: Functions <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch11-promises-and-async-functions" class="" aria-label="Chapter 11: Promises and Async Functions"><!--[--><!--]--> Chapter 11: Promises and Async Functions <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch12-the-browser-object-model" class="" aria-label="Chapter 12: The Browser Object Model"><!--[--><!--]--> Chapter 12: The Browser Object Model <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch13-client-detection" class="" aria-label="Chapter 13: Client Detection"><!--[--><!--]--> Chapter 13: Client Detection <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch14-the-document-object-model" class="" aria-label="Chapter 14: The Document Object Model"><!--[--><!--]--> Chapter 14: The Document Object Model <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch15-dom-extensions" class="" aria-label="Chapter 15: DOM Extensions"><!--[--><!--]--> Chapter 15: DOM Extensions <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch16-dom-levels-2-and-3" class="" aria-label="Chapter 16: DOM Levels 2 and 3"><!--[--><!--]--> Chapter 16: DOM Levels 2 and 3 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch17-events" class="" aria-label="Chapter 17: Events"><!--[--><!--]--> Chapter 17: Events <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch18-animation-and-graphics-with-canvas" class="" aria-label="Chapter 18: Animation and Graphics with Canvas"><!--[--><!--]--> Chapter 18: Animation and Graphics with Canvas <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch19-scripting-forms" class="" aria-label="Chapter 19: Scripting Forms"><!--[--><!--]--> Chapter 19: Scripting Forms <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch20-javascript-apis" class="" aria-label="Chapter 20: JavaScript APIs"><!--[--><!--]--> Chapter 20: JavaScript APIs <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch21-error-handling-and-debugging" class="" aria-label="Chapter 21: Error Handling and Debugging"><!--[--><!--]--> Chapter 21: Error Handling and Debugging <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch22-xml-in-javascript" class="" aria-label="Chapter 22: XML in JavaScript"><!--[--><!--]--> Chapter 22: XML in JavaScript <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch23-json" class="" aria-label="Chapter 23: JSON"><!--[--><!--]--> Chapter 23: JSON <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch24-network-requests-and-remote-resources" class="" aria-label="Chapter 24: Network Requests and Remote Resources"><!--[--><!--]--> Chapter 24: Network Requests and Remote Resources <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch25-client-side-storage" class="" aria-label="Chapter 25: Client-Side Storage"><!--[--><!--]--> Chapter 25: Client-Side Storage <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch26-modules" class="" aria-label="Chapter 26: Modules"><!--[--><!--]--> Chapter 26: Modules <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch27-workers" class="" aria-label="Chapter 27: Workers"><!--[--><!--]--> Chapter 27: Workers <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/ch28-best-practices" class="" aria-label="Chapter 28: Best Practices"><!--[--><!--]--> Chapter 28: Best Practices <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/apA-es2018-and-es2019" class="" aria-label="Appendix A: ES2018 and ES2019"><!--[--><!--]--> Appendix A: ES2018 and ES2019 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/apB-strct-mode" class="" aria-label="Appendix B: Strict Mode"><!--[--><!--]--> Appendix B: Strict Mode <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/apC-javascript-libraries-and-frameworks" class="" aria-label="Appendix C: JavaScript Libraries and Frameworks"><!--[--><!--]--> Appendix C: JavaScript Libraries and Frameworks <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ebooks/en/professional-javascript-for-web-developers-v4/apD-javascript-tools" class="" aria-label="Appendix D: JavasScript Tools"><!--[--><!--]--> Appendix D: JavasScript Tools <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">Languages</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/ebooks/zh/you-dont-know-js-v2/scope-closures/ch7.html" class="" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a aria-current="page" href="/ebooks/en/you-dont-know-js-v2/scope-closures/ch7.html" class="router-link-active router-link-exact-active router-link-active" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/us-fe/ebooks" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">Get Started <span class="right arrow"></span></p><!--[--><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/ebooks/en/you-dont-know-js-v2/get-started/" class="sidebar-item" aria-label="README"><!--[--><!--]--> README <!--[--><!--]--></a><!----></li><li><a href="/ebooks/en/you-dont-know-js-v2/get-started/ch1" class="sidebar-item" aria-label="Chapter 1: What *Is* JavaScript?"><!--[--><!--]--> Chapter 1: What *Is* JavaScript? <!--[--><!--]--></a><!----></li><li><a href="/ebooks/en/you-dont-know-js-v2/get-started/ch2" class="sidebar-item" aria-label="Chapter 2: Surveying JS"><!--[--><!--]--> Chapter 2: Surveying JS <!--[--><!--]--></a><!----></li><li><a href="/ebooks/en/you-dont-know-js-v2/get-started/ch3" class="sidebar-item" aria-label="Chapter 3: Digging to the Roots of JS"><!--[--><!--]--> Chapter 3: Digging to the Roots of JS <!--[--><!--]--></a><!----></li><li><a href="/ebooks/en/you-dont-know-js-v2/get-started/ch3" class="sidebar-item" aria-label="Chapter 4: The Bigger Picture"><!--[--><!--]--> Chapter 4: The Bigger Picture <!--[--><!--]--></a><!----></li><li><a href="/ebooks/en/you-dont-know-js-v2/get-started/apA" class="sidebar-item" aria-label="Appendix A: Exploring Further"><!--[--><!--]--> Appendix A: Exploring Further <!--[--><!--]--></a><!----></li><li><a href="/ebooks/en/you-dont-know-js-v2/get-started/apB" class="sidebar-item" aria-label="Appendix B: Practice, Practice, Practice!"><!--[--><!--]--> Appendix B: Practice, Practice, Practice! <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading active collapsible">Scope &amp; Closures <span class="down arrow"></span></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/ebooks/en/you-dont-know-js-v2/scope-closures/" class="router-link-active sidebar-item" aria-label="README"><!--[--><!--]--> README <!--[--><!--]--></a><!----></li><li><a href="/ebooks/en/you-dont-know-js-v2/scope-closures/toc" class="sidebar-item" aria-label="TOC"><!--[--><!--]--> TOC <!--[--><!--]--></a><!----></li><li><a href="/ebooks/en/you-dont-know-js-v2/scope-closures/ch1" class="sidebar-item" aria-label="Chapter 1: What&#39;s the Scope?"><!--[--><!--]--> Chapter 1: What&#39;s the Scope? <!--[--><!--]--></a><!----></li><li><a href="/ebooks/en/you-dont-know-js-v2/scope-closures/ch2" class="sidebar-item" aria-label="Chapter 2: Illustrating Lexical Scope"><!--[--><!--]--> Chapter 2: Illustrating Lexical Scope <!--[--><!--]--></a><!----></li><li><a href="/ebooks/en/you-dont-know-js-v2/scope-closures/ch3" class="sidebar-item" aria-label="Chapter 3: The Scope Chain"><!--[--><!--]--> Chapter 3: The Scope Chain <!--[--><!--]--></a><!----></li><li><a href="/ebooks/en/you-dont-know-js-v2/scope-closures/ch4" class="sidebar-item" aria-label="Chapter 4: Around the Global Scope"><!--[--><!--]--> Chapter 4: Around the Global Scope <!--[--><!--]--></a><!----></li><li><a href="/ebooks/en/you-dont-know-js-v2/scope-closures/ch5" class="sidebar-item" aria-label="Chapter 5: The (Not So) Secret Lifecycle of Variables"><!--[--><!--]--> Chapter 5: The (Not So) Secret Lifecycle of Variables <!--[--><!--]--></a><!----></li><li><a href="/ebooks/en/you-dont-know-js-v2/scope-closures/ch6" class="sidebar-item" aria-label="Chapter 6: Limiting Scope Exposure"><!--[--><!--]--> Chapter 6: Limiting Scope Exposure <!--[--><!--]--></a><!----></li><li><a href="/ebooks/en/you-dont-know-js-v2/scope-closures/ch7" class="router-link-active sidebar-item active" aria-label="Chapter 7: Using Closures"><!--[--><!--]--> Chapter 7: Using Closures <!--[--><!--]--></a><!----></li><li><a href="/ebooks/en/you-dont-know-js-v2/scope-closures/ch8" class="sidebar-item" aria-label="Chapter 8: The Module Pattern"><!--[--><!--]--> Chapter 8: The Module Pattern <!--[--><!--]--></a><!----></li><li><a href="/ebooks/en/you-dont-know-js-v2/scope-closures/apA" class="sidebar-item" aria-label="Appendix A: Exploring Further"><!--[--><!--]--> Appendix A: Exploring Further <!--[--><!--]--></a><!----></li><li><a href="/ebooks/en/you-dont-know-js-v2/scope-closures/apB" class="sidebar-item" aria-label="Appendix B: Practice"><!--[--><!--]--> Appendix B: Practice <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="you-don-t-know-js-yet-scope-closures-2nd-edition" tabindex="-1"><a class="header-anchor" href="#you-don-t-know-js-yet-scope-closures-2nd-edition" aria-hidden="true">#</a> You Don&#39;t Know JS Yet: Scope &amp; Closures - 2nd Edition</h1><h1 id="chapter-7-using-closures" tabindex="-1"><a class="header-anchor" href="#chapter-7-using-closures" aria-hidden="true">#</a> Chapter 7: Using Closures</h1><p>Up to this point, we&#39;ve focused on the ins and outs of lexical scope, and how that affects the organization and usage of variables in our programs.</p><p>Our attention again shifts broader in abstraction, to the historically somewhat daunting topic of closure. Don&#39;t worry! You don&#39;t need an advanced computer science degree to make sense of it. Our broad goal in this book is not merely to understand scope, but to more effectively use it in the structure of our programs; closure is central to that effort.</p><p>Recall the main conclusion of Chapter 6: the <em>least exposure</em> principle (POLE) encourages us to use block (and function) scoping to limit the scope exposure of variables. This helps keep code understandable and maintainable, and helps avoid many scoping pitfalls (i.e., name collision, etc.).</p><p>Closure builds on this approach: for variables we need to use over time, instead of placing them in larger outer scopes, we can encapsulate (more narrowly scope) them but still preserve access from inside functions, for broader use. Functions <em>remember</em> these referenced scoped variables via closure.</p><p>We already saw an example of this kind of closure in the previous chapter (<code>factorial(..)</code> in Chapter 6), and you&#39;ve almost certainly already used it in your own programs. If you&#39;ve ever written a callback that accesses variables outside its own scope... guess what!? That&#39;s closure.</p><p>Closure is one of the most important language characteristics ever invented in programming—it underlies major programming paradigms, including Functional Programming (FP), modules, and even a bit of class-oriented design. Getting comfortable with closure is required for mastering JS and effectively leveraging many important design patterns throughout your code.</p><p>Addressing all aspects of closure requires a daunting mountain of discussion and code throughout this chapter. Make sure to take your time and ensure you&#39;re comfortable with each bit before moving onto the next.</p><h2 id="see-the-closure" tabindex="-1"><a class="header-anchor" href="#see-the-closure" aria-hidden="true">#</a> See the Closure</h2><p>Closure is originally a mathematical concept, from lambda calculus. But I&#39;m not going to list out math formulas or use a bunch of notation and jargon to define it.</p><p>Instead, I&#39;m going to focus on a practical perspective. We&#39;ll start by defining closure in terms of what we can observe in different behavior of our programs, as opposed to if closure was not present in JS. However, later in this chapter, we&#39;re going to flip closure around to look at it from an <em>alternative perspective</em>.</p><p>Closure is a behavior of functions and only functions. If you aren&#39;t dealing with a function, closure does not apply. An object cannot have closure, nor does a class have closure (though its functions/methods might). Only functions have closure.</p><p>For closure to be observed, a function must be invoked, and specifically it must be invoked in a different branch of the scope chain from where it was originally defined. A function executing in the same scope it was defined would not exhibit any observably different behavior with or without closure being possible; by the observational perspective and definition, that is not closure.</p><p>Let&#39;s look at some code, annotated with its relevant scope bubble colors (see Chapter 2):</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// outer/global scope: RED(1)</span>

<span class="token keyword">function</span> <span class="token function">lookupStudent</span><span class="token punctuation">(</span><span class="token parameter">studentID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// function scope: BLUE(2)</span>

    <span class="token keyword">var</span> students <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Kyle&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Suzy&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">112</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Frank&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Sarah&quot;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">greetStudent</span><span class="token punctuation">(</span><span class="token parameter">greeting</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// function scope: GREEN(3)</span>

        <span class="token keyword">var</span> student <span class="token operator">=</span> students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
            <span class="token parameter">student</span> <span class="token operator">=&gt;</span> student<span class="token punctuation">.</span>id <span class="token operator">==</span> studentID
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> greeting <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> student<span class="token punctuation">.</span>name <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> chosenStudents <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token function">lookupStudent</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">lookupStudent</span><span class="token punctuation">(</span><span class="token number">112</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// accessing the function&#39;s name:</span>
chosenStudents<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
<span class="token comment">// greetStudent</span>

chosenStudents<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Hello, Sarah!</span>

chosenStudents<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">&quot;Howdy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Howdy, Frank!</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>The first thing to notice about this code is that the <code>lookupStudent(..)</code> outer function creates and returns an inner function called <code>greetStudent(..)</code>. <code>lookupStudent(..)</code> is called twice, producing two separate instances of its inner <code>greetStudent(..)</code> function, both of which are saved into the <code>chosenStudents</code> array.</p><p>We verify that&#39;s the case by checking the <code>.name</code> property of the returned function saved in <code>chosenStudents[0]</code>, and it&#39;s indeed an instance of the inner <code>greetStudent(..)</code>.</p><p>After each call to <code>lookupStudent(..)</code> finishes, it would seem like all its inner variables would be discarded and GC&#39;d (garbage collected). The inner function is the only thing that seems to be returned and preserved. But here&#39;s where the behavior differs in ways we can start to observe.</p><p>While <code>greetStudent(..)</code> does receive a single argument as the parameter named <code>greeting</code>, it also makes reference to both <code>students</code> and <code>studentID</code>, identifiers which come from the enclosing scope of <code>lookupStudent(..)</code>. Each of those references from the inner function to the variable in an outer scope is called a <em>closure</em>. In academic terms, each instance of <code>greetStudent(..)</code> <em>closes over</em> the outer variables <code>students</code> and <code>studentID</code>.</p><p>So what do those closures do here, in a concrete, observable sense?</p><p>Closure allows <code>greetStudent(..)</code> to continue to access those outer variables even after the outer scope is finished (when each call to <code>lookupStudent(..)</code> completes). Instead of the instances of <code>students</code> and <code>studentID</code> being GC&#39;d, they stay around in memory. At a later time when either instance of the <code>greetStudent(..)</code> function is invoked, those variables are still there, holding their current values.</p><p>If JS functions did not have closure, the completion of each <code>lookupStudent(..)</code> call would immediately tear down its scope and GC the <code>students</code> and <code>studentID</code> variables. When we later called one of the <code>greetStudent(..)</code> functions, what would then happen?</p><p>If <code>greetStudent(..)</code> tried to access what it thought was a BLUE(2) marble, but that marble did not actually exist (anymore), the reasonable assumption is we should get a <code>ReferenceError</code>, right?</p><p>But we don&#39;t get an error. The fact that the execution of <code>chosenStudents[0](&quot;Hello&quot;)</code> works and returns us the message &quot;Hello, Sarah!&quot;, means it was still able to access the <code>students</code> and <code>studentID</code> variables. This is a direct observation of closure!</p><h3 id="pointed-closure" tabindex="-1"><a class="header-anchor" href="#pointed-closure" aria-hidden="true">#</a> Pointed Closure</h3><p>Actually, we glossed over a little detail in the previous discussion which I&#39;m guessing many readers missed!</p><p>Because of how terse the syntax for <code>=&gt;</code> arrow functions is, it&#39;s easy to forget that they still create a scope (as asserted in &quot;Arrow Functions&quot; in Chapter 3). The <code>student =&gt; student.id == studentID</code> arrow function is creating another scope bubble inside the <code>greetStudent(..)</code> function scope.</p><p>Building on the metaphor of colored buckets and bubbles from Chapter 2, if we were creating a colored diagram for this code, there&#39;s a fourth scope at this innermost nesting level, so we&#39;d need a fourth color; perhaps we&#39;d pick ORANGE(4) for that scope:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> student <span class="token operator">=</span> students<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
    <span class="token parameter">student</span> <span class="token operator">=&gt;</span>
        <span class="token comment">// function scope: ORANGE(4)</span>
        student<span class="token punctuation">.</span>id <span class="token operator">==</span> studentID
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>The BLUE(2) <code>studentID</code> reference is actually inside the ORANGE(4) scope rather than the GREEN(3) scope of <code>greetStudent(..)</code>; also, the <code>student</code> parameter of the arrow function is ORANGE(4), shadowing the GREEN(3) <code>student</code>.</p><p>The consequence here is that this arrow function passed as a callback to the array&#39;s <code>find(..)</code> method has to hold the closure over <code>studentID</code>, rather than <code>greetStudent(..)</code> holding that closure. That&#39;s not too big of a deal, as everything still works as expected. It&#39;s just important not to skip over the fact that even tiny arrow functions can get in on the closure party.</p><h3 id="adding-up-closures" tabindex="-1"><a class="header-anchor" href="#adding-up-closures" aria-hidden="true">#</a> Adding Up Closures</h3><p>Let&#39;s examine one of the canonical examples often cited for closure:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">adder</span><span class="token punctuation">(</span><span class="token parameter">num1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">addTo</span><span class="token punctuation">(</span><span class="token parameter">num2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> num1 <span class="token operator">+</span> num2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> add10To <span class="token operator">=</span> <span class="token function">adder</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> add42To <span class="token operator">=</span> <span class="token function">adder</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">add10To</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 25</span>
<span class="token function">add42To</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 51</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>Each instance of the inner <code>addTo(..)</code> function is closing over its own <code>num1</code> variable (with values <code>10</code> and <code>42</code>, respectively), so those <code>num1</code>&#39;s don&#39;t go away just because <code>adder(..)</code> finishes. When we later invoke one of those inner <code>addTo(..)</code> instances, such as the <code>add10To(15)</code> call, its closed-over <code>num1</code> variable still exists and still holds the original <code>10</code> value. The operation is thus able to perform <code>10 + 15</code> and return the answer <code>25</code>.</p><p>An important detail might have been too easy to gloss over in that previous paragraph, so let&#39;s reinforce it: closure is associated with an instance of a function, rather than its single lexical definition. In the preceding snippet, there&#39;s just one inner <code>addTo(..)</code> function defined inside <code>adder(..)</code>, so it might seem like that would imply a single closure.</p><p>But actually, every time the outer <code>adder(..)</code> function runs, a <em>new</em> inner <code>addTo(..)</code> function instance is created, and for each new instance, a new closure. So each inner function instance (labeled <code>add10To(..)</code> and <code>add42To(..)</code> in our program) has its own closure over its own instance of the scope environment from that execution of <code>adder(..)</code>.</p><p>Even though closure is based on lexical scope, which is handled at compile time, closure is observed as a runtime characteristic of function instances.</p><h3 id="live-link-not-a-snapshot" tabindex="-1"><a class="header-anchor" href="#live-link-not-a-snapshot" aria-hidden="true">#</a> Live Link, Not a Snapshot</h3><p>In both examples from the previous sections, we <strong>read the value from a variable</strong> that was held in a closure. That makes it feel like closure might be a snapshot of a value at some given moment. Indeed, that&#39;s a common misconception.</p><p>Closure is actually a live link, preserving access to the full variable itself. We&#39;re not limited to merely reading a value; the closed-over variable can be updated (re-assigned) as well! By closing over a variable in a function, we can keep using that variable (read and write) as long as that function reference exists in the program, and from anywhere we want to invoke that function. This is why closure is such a powerful technique used widely across so many areas of programming!</p><p>Figure 4 depicts the function instances and scope links:</p><figure><img src="/ebooks/you-dont-know-js-v2/scope-closures/images/fig4.png" width="400" alt="Function instances linked to scopes via closure" align="center"><figcaption><em>Fig. 4: Visualizing Closures</em></figcaption><br><br></figure><p>As shown in Figure 4, each call to <code>adder(..)</code> creates a new BLUE(2) scope containing a <code>num1</code> variable, as well as a new instance of <code>addTo(..)</code> function as a GREEN(3) scope. Notice that the function instances (<code>addTo10(..)</code> and <code>addTo42(..)</code>) are present in and invoked from the RED(1) scope.</p><p>Now let&#39;s examine an example where the closed-over variable is updated:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">makeCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> hits <span class="token operator">=</span> <span class="token function">makeCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// later</span>

<span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 1</span>

<span class="token comment">// later</span>

<span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 2</span>
<span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 3</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>The <code>count</code> variable is closed over by the inner <code>getCurrent()</code> function, which keeps it around instead of it being subjected to GC. The <code>hits()</code> function calls access <em>and</em> update this variable, returning an incrementing count each time.</p><p>Though the enclosing scope of a closure is typically from a function, that&#39;s not actually required; there only needs to be an inner function present inside an outer scope:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> hits<span class="token punctuation">;</span>
<span class="token punctuation">{</span>   <span class="token comment">// an outer scope (but not a function)</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function-variable function">hits</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 1</span>
<span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 2</span>
<span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 3</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><table><thead><tr><th style="text-align:left;">NOTE:</th></tr></thead><tbody><tr><td style="text-align:left;">I deliberately defined <code>getCurrent()</code> as a <code>function</code> expression instead of a <code>function</code> declaration. This isn&#39;t about closure, but with the dangerous quirks of FiB (Chapter 6).</td></tr></tbody></table><p>Because it&#39;s so common to mistake closure as value-oriented instead of variable-oriented, developers sometimes get tripped up trying to use closure to snapshot-preserve a value from some moment in time. Consider:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> studentName <span class="token operator">=</span> <span class="token string">&quot;Frank&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">greeting</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// we are closing over `studentName`,</span>
    <span class="token comment">// not &quot;Frank&quot;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Hello, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> studentName <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// later</span>

studentName <span class="token operator">=</span> <span class="token string">&quot;Suzy&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// later</span>

<span class="token function">greeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Hello, Suzy!</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>By defining <code>greeting()</code> (aka, <code>hello()</code>) when <code>studentName</code> holds the value <code>&quot;Frank&quot;</code> (before the re-assignment to <code>&quot;Suzy&quot;</code>), the mistaken assumption is often that the closure will capture <code>&quot;Frank&quot;</code>. But <code>greeting()</code> is closed over the variable <code>studentName</code>, not its value. Whenever <code>greeting()</code> is invoked, the current value of the variable (<code>&quot;Suzy&quot;</code>, in this case) is reflected.</p><p>The classic illustration of this mistake is defining functions inside a loop:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> keeps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    keeps<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">keepI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// closure over `i`</span>
        <span class="token keyword">return</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

keeps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 3 -- WHY!?</span>
keeps<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 3</span>
keeps<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 3</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><table><thead><tr><th style="text-align:left;">NOTE:</th></tr></thead><tbody><tr><td style="text-align:left;">This kind of closure illustration typically uses a <code>setTimeout(..)</code> or some other callback like an event handler, inside the loop. I&#39;ve simplified the example by storing function references in an array, so that we don&#39;t need to consider asynchronous timing in our analysis. The closure principle is the same, regardless.</td></tr></tbody></table><p>You might have expected the <code>keeps[0]()</code> invocation to return <code>0</code>, since that function was created during the first iteration of the loop when <code>i</code> was <code>0</code>. But again, that assumption stems from thinking of closure as value-oriented rather than variable-oriented.</p><p>Something about the structure of a <code>for</code>-loop can trick us into thinking that each iteration gets its own new <code>i</code> variable; in fact, this program only has one <code>i</code> since it was declared with <code>var</code>.</p><p>Each saved function returns <code>3</code>, because by the end of the loop, the single <code>i</code> variable in the program has been assigned <code>3</code>. Each of the three functions in the <code>keeps</code> array do have individual closures, but they&#39;re all closed over that same shared <code>i</code> variable.</p><p>Of course, a single variable can only ever hold one value at any given moment. So if you want to preserve multiple values, you need a different variable for each.</p><p>How could we do that in the loop snippet? Let&#39;s create a new variable for each iteration:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> keeps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// new `j` created each iteration, which gets</span>
    <span class="token comment">// a copy of the value of `i` at this moment</span>
    <span class="token keyword">let</span> j <span class="token operator">=</span> i<span class="token punctuation">;</span>

    <span class="token comment">// the `i` here isn&#39;t being closed over, so</span>
    <span class="token comment">// it&#39;s fine to immediately use its current</span>
    <span class="token comment">// value in each loop iteration</span>
    keeps<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">keepEachJ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// close over `j`, not `i`!</span>
        <span class="token keyword">return</span> j<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
keeps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 0</span>
keeps<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 1</span>
keeps<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 2</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>Each function is now closed over a separate (new) variable from each iteration, even though all of them are named <code>j</code>. And each <code>j</code> gets a copy of the value of <code>i</code> at that point in the loop iteration; that <code>j</code> never gets re-assigned. So all three functions now return their expected values: <code>0</code>, <code>1</code>, and <code>2</code>!</p><p>Again remember, even if we were using asynchrony in this program, such as passing each inner <code>keepEachJ()</code> function into <code>setTimeout(..)</code> or some event handler subscription, the same kind of closure behavior would still be observed.</p><p>Recall the &quot;Loops&quot; section in Chapter 5, which illustrates how a <code>let</code> declaration in a <code>for</code> loop actually creates not just one variable for the loop, but actually creates a new variable for <em>each iteration</em> of the loop. That trick/quirk is exactly what we need for our loop closures:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> keeps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// the `let i` gives us a new `i` for</span>
    <span class="token comment">// each iteration, automatically!</span>
    keeps<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">keepEachI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
keeps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 0</span>
keeps<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 1</span>
keeps<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 2</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>Since we&#39;re using <code>let</code>, three <code>i</code>&#39;s are created, one for each loop, so each of the three closures <em>just work</em> as expected.</p><h3 id="common-closures-ajax-and-events" tabindex="-1"><a class="header-anchor" href="#common-closures-ajax-and-events" aria-hidden="true">#</a> Common Closures: Ajax and Events</h3><p>Closure is most commonly encountered with callbacks:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">lookupStudentRecord</span><span class="token punctuation">(</span><span class="token parameter">studentID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ajax</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://some.api/student/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> studentID <span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token keyword">function</span> <span class="token function">onRecord</span><span class="token punctuation">(</span><span class="token parameter">record</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
                <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> record<span class="token punctuation">.</span>name <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> studentID <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">lookupStudentRecord</span><span class="token punctuation">(</span><span class="token number">114</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Frank (114)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>The <code>onRecord(..)</code> callback is going to be invoked at some point in the future, after the response from the Ajax call comes back. This invocation will happen from the internals of the <code>ajax(..)</code> utility, wherever that comes from. Furthermore, when that happens, the <code>lookupStudentRecord(..)</code> call will long since have completed.</p><p>Why then is <code>studentID</code> still around and accessible to the callback? Closure.</p><p>Event handlers are another common usage of closure:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">listenForClicks</span><span class="token punctuation">(</span><span class="token parameter">btn<span class="token punctuation">,</span>label</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> label <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> button was clicked!</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> submitBtn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;submit-btn&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">listenForClicks</span><span class="token punctuation">(</span>submitBtn<span class="token punctuation">,</span><span class="token string">&quot;Checkout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>The <code>label</code> parameter is closed over by the <code>onClick(..)</code> event handler callback. When the button is clicked, <code>label</code> still exists to be used. This is closure.</p><h3 id="what-if-i-can-t-see-it" tabindex="-1"><a class="header-anchor" href="#what-if-i-can-t-see-it" aria-hidden="true">#</a> What If I Can&#39;t See It?</h3><p>You&#39;ve probably heard this common adage:</p><blockquote><p>If a tree falls in the forest but nobody is around to hear it, does it make a sound?</p></blockquote><p>It&#39;s a silly bit of philosophical gymnastics. Of course from a scientific perspective, sound waves are created. But the real point: <em>does it matter</em> if the sound happens?</p><p>Remember, the emphasis in our definition of closure is observability. If a closure exists (in a technical, implementation, or academic sense) but it cannot be observed in our programs, <em>does it matter?</em> No.</p><p>To reinforce this point, let&#39;s look at some examples that are <em>not</em> observably based on closure.</p><p>For example, invoking a function that makes use of lexical scope lookup:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token parameter">myName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> greeting <span class="token operator">=</span> <span class="token string">&quot;Hello&quot;</span><span class="token punctuation">;</span>
    <span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">output</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> greeting <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> myName <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">say</span><span class="token punctuation">(</span><span class="token string">&quot;Kyle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Hello, Kyle!</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>The inner function <code>output()</code> accesses the variables <code>greeting</code> and <code>myName</code> from its enclosing scope. But the invocation of <code>output()</code> happens in that same scope, where of course <code>greeting</code> and <code>myName</code> are still available; that&#39;s just lexical scope, not closure.</p><p>Any lexically scoped language whose functions didn&#39;t support closure would still behave this same way.</p><p>In fact, global scope variables essentially cannot be (observably) closed over, because they&#39;re always accessible from everywhere. No function can ever be invoked in any part of the scope chain that is not a descendant of the global scope.</p><p>Consider:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> students <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Kyle&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Suzy&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">112</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Frank&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Sarah&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getFirstStudent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">firstStudent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> students<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> student <span class="token operator">=</span> <span class="token function">getFirstStudent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Kyle</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>The inner <code>firstStudent()</code> function does reference <code>students</code>, which is a variable outside its own scope. But since <code>students</code> happens to be from the global scope, no matter where that function is invoked in the program, its ability to access <code>students</code> is nothing more special than normal lexical scope.</p><p>All function invocations can access global variables, regardless of whether closure is supported by the language or not. Global variables don&#39;t need to be closed over.</p><p>Variables that are merely present but never accessed don&#39;t result in closure:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">lookupStudent</span><span class="token punctuation">(</span><span class="token parameter">studentID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">nobody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> msg <span class="token operator">=</span> <span class="token string">&quot;Nobody&#39;s here yet.&quot;</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> student <span class="token operator">=</span> <span class="token function">lookupStudent</span><span class="token punctuation">(</span><span class="token number">112</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Nobody&#39;s here yet.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>The inner function <code>nobody()</code> doesn&#39;t close over any outer variables—it only uses its own variable <code>msg</code>. Even though <code>studentID</code> is present in the enclosing scope, <code>studentID</code> is not referred to by <code>nobody()</code>. The JS engine doesn&#39;t need to keep <code>studentID</code> around after <code>lookupStudent(..)</code> has finished running, so GC wants to clean up that memory!</p><p>Whether JS functions support closure or not, this program would behave the same. Therefore, no observed closure here.</p><p>If there&#39;s no function invocation, closure can&#39;t be observed:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">greetStudent</span><span class="token punctuation">(</span><span class="token parameter">studentName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">greeting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Hello, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span> studentName <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">greetStudent</span><span class="token punctuation">(</span><span class="token string">&quot;Kyle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// nothing else happens</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>This one&#39;s tricky, because the outer function definitely does get invoked. But the inner function is the one that <em>could</em> have had closure, and yet it&#39;s never invoked; the returned function here is just thrown away. So even if technically the JS engine created closure for a brief moment, it was not observed in any meaningful way in this program.</p><p>A tree may have fallen... but we didn&#39;t hear it, so we don&#39;t care.</p><h3 id="observable-definition" tabindex="-1"><a class="header-anchor" href="#observable-definition" aria-hidden="true">#</a> Observable Definition</h3><p>We&#39;re now ready to define closure:</p><blockquote><p>Closure is observed when a function uses variable(s) from outer scope(s) even while running in a scope where those variable(s) wouldn&#39;t be accessible.</p></blockquote><p>The key parts of this definition are:</p><ul><li><p>Must be a function involved</p></li><li><p>Must reference at least one variable from an outer scope</p></li><li><p>Must be invoked in a different branch of the scope chain from the variable(s)</p></li></ul><p>This observation-oriented definition means we shouldn&#39;t dismiss closure as some indirect, academic trivia. Instead, we should look and plan for the direct, concrete effects closure has on our program behavior.</p><h2 id="the-closure-lifecycle-and-garbage-collection-gc" tabindex="-1"><a class="header-anchor" href="#the-closure-lifecycle-and-garbage-collection-gc" aria-hidden="true">#</a> The Closure Lifecycle and Garbage Collection (GC)</h2><p>Since closure is inherently tied to a function instance, its closure over a variable lasts as long as there is still a reference to that function.</p><p>If ten functions all close over the same variable, and over time nine of these function references are discarded, the lone remaining function reference still preserves that variable. Once that final function reference is discarded, the last closure over that variable is gone, and the variable itself is GC&#39;d.</p><p>This has an important impact on building efficient and performant programs. Closure can unexpectedly prevent the GC of a variable that you&#39;re otherwise done with, which leads to run-away memory usage over time. That&#39;s why it&#39;s important to discard function references (and thus their closures) when they&#39;re not needed anymore.</p><p>Consider:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">manageBtnClickEvents</span><span class="token punctuation">(</span><span class="token parameter">btn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> clickHandlers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">listener</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token function-variable function">clickHandler</span> <span class="token operator">=</span>
                <span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;clicked!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">cb</span><span class="token punctuation">(</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
            clickHandlers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>clickHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
                <span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span>
                clickHandler
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// passing no callback unsubscribes</span>
            <span class="token comment">// all click handlers</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> handler <span class="token keyword">of</span> clickHandlers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                btn<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span>
                    handler
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            clickHandlers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// var mySubmitBtn = ..</span>
<span class="token keyword">var</span> onSubmit <span class="token operator">=</span> <span class="token function">manageBtnClickEvents</span><span class="token punctuation">(</span>mySubmitBtn<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">onSubmit</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">checkout</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// handle checkout</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">onSubmit</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">trackAction</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// log action to analytics</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// later, unsubscribe all handlers:</span>
<span class="token function">onSubmit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><p>In this program, the inner <code>onClick(..)</code> function holds a closure over the passed in <code>cb</code> (the provided event callback). That means the <code>checkout()</code> and <code>trackAction()</code> function expression references are held via closure (and cannot be GC&#39;d) for as long as these event handlers are subscribed.</p><p>When we call <code>onSubmit()</code> with no input on the last line, all event handlers are unsubscribed, and the <code>clickHandlers</code> array is emptied. Once all click handler function references are discarded, the closures of <code>cb</code> references to <code>checkout()</code> and <code>trackAction()</code> are discarded.</p><p>When considering the overall health and efficiency of the program, unsubscribing an event handler when it&#39;s no longer needed can be even more important than the initial subscription!</p><h3 id="per-variable-or-per-scope" tabindex="-1"><a class="header-anchor" href="#per-variable-or-per-scope" aria-hidden="true">#</a> Per Variable or Per Scope?</h3><p>Another question we need to tackle: should we think of closure as applied only to the referenced outer variable(s), or does closure preserve the entire scope chain with all its variables?</p><p>In other words, in the previous event subscription snippet, is the inner <code>onClick(..)</code> function closed over only <code>cb</code>, or is it also closed over <code>clickHandler</code>, <code>clickHandlers</code>, and <code>btn</code>?</p><p>Conceptually, closure is <strong>per variable</strong> rather than <em>per scope</em>. Ajax callbacks, event handlers, and all other forms of function closures are typically assumed to close over only what they explicitly reference.</p><p>But the reality is more complicated than that.</p><p>Another program to consider:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">manageStudentGrades</span><span class="token punctuation">(</span><span class="token parameter">studentRecords</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> grades <span class="token operator">=</span> studentRecords<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>getGrade<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> addGrade<span class="token punctuation">;</span>

    <span class="token comment">// ************************</span>

    <span class="token keyword">function</span> <span class="token function">getGrade</span><span class="token punctuation">(</span><span class="token parameter">record</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> record<span class="token punctuation">.</span>grade<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">sortAndTrimGradesList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// sort by grades, descending</span>
        grades<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">desc</span><span class="token punctuation">(</span><span class="token parameter">g1<span class="token punctuation">,</span>g2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> g2 <span class="token operator">-</span> g1<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// only keep the top 10 grades</span>
        grades <span class="token operator">=</span> grades<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">addGrade</span><span class="token punctuation">(</span><span class="token parameter">newGrade</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        grades<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newGrade<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sortAndTrimGradesList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> grades<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> addNextGrade <span class="token operator">=</span> <span class="token function">manageStudentGrades</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Kyle&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">86</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Suzy&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">87</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">112</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Frank&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">75</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ..many more records..</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;Sarah&quot;</span><span class="token punctuation">,</span> <span class="token literal-property property">grade</span><span class="token operator">:</span> <span class="token number">91</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// later</span>

<span class="token function">addNextGrade</span><span class="token punctuation">(</span><span class="token number">81</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">addNextGrade</span><span class="token punctuation">(</span><span class="token number">68</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// [ .., .., ... ]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>The outer function <code>manageStudentGrades(..)</code> takes a list of student records, and returns an <code>addGrade(..)</code> function reference, which we externally label <code>addNextGrade(..)</code>. Each time we call <code>addNextGrade(..)</code> with a new grade, we get back a current list of the top 10 grades, sorted numerically descending (see <code>sortAndTrimGradesList()</code>).</p><p>From the end of the original <code>manageStudentGrades(..)</code> call, and between the multiple <code>addNextGrade(..)</code> calls, the <code>grades</code> variable is preserved inside <code>addGrade(..)</code> via closure; that&#39;s how the running list of top grades is maintained. Remember, it&#39;s a closure over the variable <code>grades</code> itself, not the array it holds.</p><p>That&#39;s not the only closure involved, however. Can you spot other variables being closed over?</p><p>Did you spot that <code>addGrade(..)</code> references <code>sortAndTrimGradesList</code>? That means it&#39;s also closed over that identifier, which happens to hold a reference to the <code>sortAndTrimGradesList()</code> function. That second inner function has to stay around so that <code>addGrade(..)</code> can keep calling it, which also means any variables <em>it</em> closes over stick around—though, in this case, nothing extra is closed over there.</p><p>What else is closed over?</p><p>Consider the <code>getGrade</code> variable (and its function); is it closed over? It&#39;s referenced in the outer scope of <code>manageStudentGrades(..)</code> in the <code>.map(getGrade)</code> call. But it&#39;s not referenced in <code>addGrade(..)</code> or <code>sortAndTrimGradesList()</code>.</p><p>What about the (potentially) large list of student records we pass in as <code>studentRecords</code>? Is that variable closed over? If it is, the array of student records is never getting GC&#39;d, which leads to this program holding onto a larger amount of memory than we might assume. But if we look closely again, none of the inner functions reference <code>studentRecords</code>.</p><p>According to the <em>per variable</em> definition of closure, since <code>getGrade</code> and <code>studentRecords</code> are <em>not</em> referenced by the inner functions, they&#39;re not closed over. They should be freely available for GC right after the <code>manageStudentGrades(..)</code> call completes.</p><p>Indeed, try debugging this code in a recent JS engine, like v8 in Chrome, placing a breakpoint inside the <code>addGrade(..)</code> function. You may notice that the inspector <strong>does not</strong> list the <code>studentRecords</code> variable. That&#39;s proof, debugging-wise anyway, that the engine does not maintain <code>studentRecords</code> via closure. Phew!</p><p>But how reliable is this observation as proof? Consider this (rather contrived!) program:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">storeStudentInfo</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span>name<span class="token punctuation">,</span>grade</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token parameter">whichValue</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// warning:</span>
        <span class="token comment">//   using `eval(..)` is a bad idea!</span>
        <span class="token keyword">var</span> val <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span>whichValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> val<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> info <span class="token operator">=</span> <span class="token function">storeStudentInfo</span><span class="token punctuation">(</span><span class="token number">73</span><span class="token punctuation">,</span><span class="token string">&quot;Suzy&quot;</span><span class="token punctuation">,</span><span class="token number">87</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Suzy</span>

<span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;grade&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 87</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>Notice that the inner function <code>getInfo(..)</code> is not explicitly closed over any of <code>id</code>, <code>name</code>, or <code>grade</code> variables. And yet, calls to <code>info(..)</code> seem to still be able to access the variables, albeit through use of the <code>eval(..)</code> lexical scope cheat (see Chapter 1).</p><p>So all the variables were definitely preserved via closure, despite not being explicitly referenced by the inner function. So does that disprove the <em>per variable</em> assertion in favor of <em>per scope</em>? Depends.</p><p>Many modern JS engines do apply an <em>optimization</em> that removes any variables from a closure scope that aren&#39;t explicitly referenced. However, as we see with <code>eval(..)</code>, there are situations where such an optimization cannot be applied, and the closure scope continues to contain all its original variables. In other words, closure must be <em>per scope</em>, implementation wise, and then an optional optimization trims down the scope to only what was closed over (a similar outcome as <em>per variable</em> closure).</p><p>Even as recent as a few years ago, many JS engines did not apply this optimization; it&#39;s possible your websites may still run in such browsers, especially on older or lower-end devices. That means it&#39;s possible that long-lived closures such as event handlers may be holding onto memory much longer than we would have assumed.</p><p>And the fact that it&#39;s an optional optimization in the first place, rather than a requirement of the specification, means that we shouldn&#39;t just casually over-assume its applicability.</p><p>In cases where a variable holds a large value (like an object or array) and that variable is present in a closure scope, if you don&#39;t need that value anymore and don&#39;t want that memory held, it&#39;s safer (memory usage) to manually discard the value rather than relying on closure optimization/GC.</p><p>Let&#39;s apply a <em>fix</em> to the earlier <code>manageStudentGrades(..)</code> example to ensure the potentially large array held in <code>studentRecords</code> is not caught up in a closure scope unnecessarily:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">manageStudentGrades</span><span class="token punctuation">(</span><span class="token parameter">studentRecords</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> grades <span class="token operator">=</span> studentRecords<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>getGrade<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// unset `studentRecords` to prevent unwanted</span>
    <span class="token comment">// memory retention in the closure</span>
    studentRecords <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> addGrade<span class="token punctuation">;</span>
    <span class="token comment">// ..</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>We&#39;re not removing <code>studentRecords</code> from the closure scope; that we cannot control. We&#39;re ensuring that even if <code>studentRecords</code> remains in the closure scope, that variable is no longer referencing the potentially large array of data; the array can be GC&#39;d.</p><p>Again, in many cases JS might automatically optimize the program to the same effect. But it&#39;s still a good habit to be careful and explicitly make sure we don&#39;t keep any significant amount of device memory tied up any longer than necessary.</p><p>As a matter of fact, we also technically don&#39;t need the function <code>getGrade()</code> anymore after the <code>.map(getGrade)</code> call completes. If profiling our application showed this was a critical area of excess memory use, we could possibly eek out a tiny bit more memory by freeing up that reference so its value isn&#39;t tied up either. That&#39;s likely unnecessary in this toy example, but this is a general technique to keep in mind if you&#39;re optimizing the memory footprint of your application.</p><p>The takeaway: it&#39;s important to know where closures appear in our programs, and what variables are included. We should manage these closures carefully so we&#39;re only holding onto what&#39;s minimally needed and not wasting memory.</p><h2 id="an-alternative-perspective" tabindex="-1"><a class="header-anchor" href="#an-alternative-perspective" aria-hidden="true">#</a> An Alternative Perspective</h2><p>Reviewing our working definition for closure, the assertion is that functions are &quot;first-class values&quot; that can be passed around the program, just like any other value. Closure is the link-association that connects that function to the scope/variables outside of itself, no matter where that function goes.</p><p>Let&#39;s recall a code example from earlier in this chapter, again with relevant scope bubble colors annotated:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// outer/global scope: RED(1)</span>

<span class="token keyword">function</span> <span class="token function">adder</span><span class="token punctuation">(</span><span class="token parameter">num1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// function scope: BLUE(2)</span>

    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">addTo</span><span class="token punctuation">(</span><span class="token parameter">num2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// function scope: GREEN(3)</span>

        <span class="token keyword">return</span> num1 <span class="token operator">+</span> num2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> add10To <span class="token operator">=</span> <span class="token function">adder</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> add42To <span class="token operator">=</span> <span class="token function">adder</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">add10To</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 25</span>
<span class="token function">add42To</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 51</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>Our current perspective suggests that wherever a function is passed and invoked, closure preserves a hidden link back to the original scope to facilitate the access to the closed-over variables. Figure 4, repeated here for convenience, illustrates this notion:</p><figure><img src="/ebooks/you-dont-know-js-v2/scope-closures/images/fig4.png" width="400" alt="Function instances linked to scopes via closure" align="center"><figcaption><em>Fig. 4 (repeat): Visualizing Closures</em></figcaption><br><br></figure><p>But there&#39;s another way of thinking about closure, and more precisely the nature of functions being <em>passed around</em>, that may help deepen the mental models.</p><p>This alternative model de-emphasizes &quot;functions as first-class values,&quot; and instead embraces how functions (like all non-primitive values) are held by reference in JS, and assigned/passed by reference-copy—see Appendix A of the <em>Get Started</em> book for more information.</p><p>Instead of thinking about the inner function instance of <code>addTo(..)</code> moving to the outer RED(1) scope via the <code>return</code> and assignment, we can envision that function instances actually just stay in place in their own scope environment, of course with their scope-chain intact.</p><p>What gets <em>sent</em> to the RED(1) scope is <strong>just a reference</strong> to the in-place function instance, rather than the function instance itself. Figure 5 depicts the inner function instances remaining in place, pointed to by the RED(1) <code>addTo10</code> and <code>addTo42</code> references, respectively:</p><figure><img src="/ebooks/you-dont-know-js-v2/scope-closures/images/fig5.png" width="400" alt="Function instances inside scopes via closure, linked to by references" align="center"><figcaption><em>Fig. 5: Visualizing Closures (Alternative)</em></figcaption><br><br></figure><p>As shown in Figure 5, each call to <code>adder(..)</code> still creates a new BLUE(2) scope containing a <code>num1</code> variable, as well as an instance of the GREEN(3) <code>addTo(..)</code> scope. But what&#39;s different from Figure 4 is, now these GREEN(3) instances remain in place, naturally nested inside of their BLUE(2) scope instances. The <code>addTo10</code> and <code>addTo42</code> references are moved to the RED(1) outer scope, not the function instances themselves.</p><p>When <code>addTo10(15)</code> is called, the <code>addTo(..)</code> function instance (still in place in its original BLUE(2) scope environment) is invoked. Since the function instance itself never moved, of course it still has natural access to its scope chain. Same with the <code>addTo42(9)</code> call—nothing special here beyond lexical scope.</p><p>So what then <em>is</em> closure, if not the <em>magic</em> that lets a function maintain a link to its original scope chain even as that function moves around in other scopes? In this alternative model, functions stay in place and keep accessing their original scope chain just like they always could.</p><p>Closure instead describes the <em>magic</em> of <strong>keeping alive a function instance</strong>, along with its whole scope environment and chain, for as long as there&#39;s at least one reference to that function instance floating around in any other part of the program.</p><p>That definition of closure is less observational and a bit less familiar-sounding compared to the traditional academic perspective. But it&#39;s nonetheless still useful, because the benefit is that we simplify explanation of closure to a straightforward combination of references and in-place function instances.</p><p>The previous model (Figure 4) is not <em>wrong</em> at describing closure in JS. It&#39;s just more conceptually inspired, an academic perspective on closure. By contrast, the alternative model (Figure 5) could be described as a bit more implementation focused, how JS actually works.</p><p>Both perspectives/models are useful in understanding closure, but the reader may find one a little easier to hold than the other. Whichever you choose, the observable outcomes in our program are the same.</p><table><thead><tr><th style="text-align:left;">NOTE:</th></tr></thead><tbody><tr><td style="text-align:left;">This alternative model for closure does affect whether we classify synchronous callbacks as examples of closure or not. More on this nuance in Appendix A.</td></tr></tbody></table><h2 id="why-closure" tabindex="-1"><a class="header-anchor" href="#why-closure" aria-hidden="true">#</a> Why Closure?</h2><p>Now that we have a well-rounded sense of what closure is and how it works, let&#39;s explore some ways it can improve the code structure and organization of an example program.</p><p>Imagine you have a button on a page that when clicked, should retrieve and send some data via an Ajax request. Without using closure:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> APIendpoints <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">studentIDs</span><span class="token operator">:</span>
        <span class="token string">&quot;https://some.api/register-students&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// ..</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">studentIDs</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token number">112</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// ..</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">makeRequest</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> btn <span class="token operator">=</span> evt<span class="token punctuation">.</span>target<span class="token punctuation">;</span>
    <span class="token keyword">var</span> recordKind <span class="token operator">=</span> btn<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>kind<span class="token punctuation">;</span>
    <span class="token function">ajax</span><span class="token punctuation">(</span>
        APIendpoints<span class="token punctuation">[</span>recordKind<span class="token punctuation">]</span><span class="token punctuation">,</span>
        data<span class="token punctuation">[</span>recordKind<span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// &lt;button data-kind=&quot;studentIDs&quot;&gt;</span>
<span class="token comment">//    Register Students</span>
<span class="token comment">// &lt;/button&gt;</span>
btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span>makeRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>The <code>makeRequest(..)</code> utility only receives an <code>evt</code> object from a click event. From there, it has to retrieve the <code>data-kind</code> attribute from the target button element, and use that value to lookup both a URL for the API endpoint as well as what data should be included in the Ajax request.</p><p>This works OK, but it&#39;s unfortunate (inefficient, more confusing) that the event handler has to read a DOM attribute each time it&#39;s fired. Why couldn&#39;t an event handler <em>remember</em> this value? Let&#39;s try using closure to improve the code:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">var</span> APIendpoints <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">studentIDs</span><span class="token operator">:</span>
        <span class="token string">&quot;https://some.api/register-students&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// ..</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">studentIDs</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">73</span><span class="token punctuation">,</span> <span class="token number">112</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// ..</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">setupButtonHandler</span><span class="token punctuation">(</span><span class="token parameter">btn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> recordKind <span class="token operator">=</span> btn<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>kind<span class="token punctuation">;</span>

    btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
        <span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span>
        <span class="token keyword">function</span> <span class="token function">makeRequest</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">ajax</span><span class="token punctuation">(</span>
                APIendpoints<span class="token punctuation">[</span>recordKind<span class="token punctuation">]</span><span class="token punctuation">,</span>
                data<span class="token punctuation">[</span>recordKind<span class="token punctuation">]</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// &lt;button data-kind=&quot;studentIDs&quot;&gt;</span>
<span class="token comment">//    Register Students</span>
<span class="token comment">// &lt;/button&gt;</span>

<span class="token function">setupButtonHandler</span><span class="token punctuation">(</span>btn<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>With the <code>setupButtonHandler(..)</code> approach, the <code>data-kind</code> attribute is retrieved once and assigned to the <code>recordKind</code> variable at initial setup. <code>recordKind</code> is then closed over by the inner <code>makeRequest(..)</code> click handler, and its value is used on each event firing to look up the URL and data that should be sent.</p><table><thead><tr><th style="text-align:left;">NOTE:</th></tr></thead><tbody><tr><td style="text-align:left;"><code>evt</code> is still passed to <code>makeRequest(..)</code>, though in this case we&#39;re not using it anymore. It&#39;s still listed, for consistency with the previous snippet.</td></tr></tbody></table><p>By placing <code>recordKind</code> inside <code>setupButtonHandler(..)</code>, we limit the scope exposure of that variable to a more appropriate subset of the program; storing it globally would have been worse for code organization and readability. Closure lets the inner <code>makeRequest()</code> function instance <em>remember</em> this variable and access whenever it&#39;s needed.</p><p>Building on this pattern, we could have looked up both the URL and data once, at setup:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">setupButtonHandler</span><span class="token punctuation">(</span><span class="token parameter">btn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> recordKind <span class="token operator">=</span> btn<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>kind<span class="token punctuation">;</span>
    <span class="token keyword">var</span> requestURL <span class="token operator">=</span> APIendpoints<span class="token punctuation">[</span>recordKind<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> requestData <span class="token operator">=</span> data<span class="token punctuation">[</span>recordKind<span class="token punctuation">]</span><span class="token punctuation">;</span>

    btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
        <span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span>
        <span class="token keyword">function</span> <span class="token function">makeRequest</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">ajax</span><span class="token punctuation">(</span>requestURL<span class="token punctuation">,</span>requestData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>Now <code>makeRequest(..)</code> is closed over <code>requestURL</code> and <code>requestData</code>, which is a little bit cleaner to understand, and also slightly more performant.</p><p>Two similar techniques from the Functional Programming (FP) paradigm that rely on closure are partial application and currying. Briefly, with these techniques, we alter the <em>shape</em> of functions that require multiple inputs so some inputs are provided up front, and other inputs are provided later; the initial inputs are remembered via closure. Once all inputs have been provided, the underlying action is performed.</p><p>By creating a function instance that encapsulates some information inside (via closure), the function-with-stored-information can later be used directly without needing to re-provide that input. This makes that part of the code cleaner, and also offers the opportunity to label partially applied functions with better semantic names.</p><p>Adapting partial application, we can further improve the preceding code:</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">defineHandler</span><span class="token punctuation">(</span><span class="token parameter">requestURL<span class="token punctuation">,</span>requestData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">makeRequest</span><span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">ajax</span><span class="token punctuation">(</span>requestURL<span class="token punctuation">,</span>requestData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">setupButtonHandler</span><span class="token punctuation">(</span><span class="token parameter">btn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> recordKind <span class="token operator">=</span> btn<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>kind<span class="token punctuation">;</span>
    <span class="token keyword">var</span> handler <span class="token operator">=</span> <span class="token function">defineHandler</span><span class="token punctuation">(</span>
        APIendpoints<span class="token punctuation">[</span>recordKind<span class="token punctuation">]</span><span class="token punctuation">,</span>
        data<span class="token punctuation">[</span>recordKind<span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    btn<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>The <code>requestURL</code> and <code>requestData</code> inputs are provided ahead of time, resulting in the <code>makeRequest(..)</code> partially applied function, which we locally label <code>handler</code>. When the event eventually fires, the final input (<code>evt</code>, even though it&#39;s ignored) is passed to <code>handler()</code>, completing its inputs and triggering the underlying Ajax request.</p><p>Behavior-wise, this program is pretty similar to the previous one, with the same type of closure. But by isolating the creation of <code>makeRequest(..)</code> in a separate utility (<code>defineHandler(..)</code>), we make that definition more reusable across the program. We also explicitly limit the closure scope to only the two variables needed.</p><h2 id="closer-to-closure" tabindex="-1"><a class="header-anchor" href="#closer-to-closure" aria-hidden="true">#</a> Closer to Closure</h2><p>As we close down a dense chapter, take some deep breaths let it all sink in. Seriously, that&#39;s a lot of information for anyone to consume!</p><p>We explored two models for mentally tackling closure:</p><ul><li><p>Observational: closure is a function instance remembering its outer variables even as that function is passed to and <strong>invoked in</strong> other scopes.</p></li><li><p>Implementational: closure is a function instance and its scope environment preserved in-place while any references to it are passed around and <strong>invoked from</strong> other scopes.</p></li></ul><p>Summarizing the benefits to our programs:</p><ul><li><p>Closure can improve efficiency by allowing a function instance to remember previously determined information instead of having to compute it each time.</p></li><li><p>Closure can improve code readability, bounding scope-exposure by encapsulating variable(s) inside function instances, while still making sure the information in those variables is accessible for future use. The resultant narrower, more specialized function instances are cleaner to interact with, since the preserved information doesn&#39;t need to be passed in every invocation.</p></li></ul><p>Before you move on, take some time to restate this summary <em>in your own words</em>, explaining what closure is and why it&#39;s helpful in your programs. The main book text concludes with a final chapter that builds on top of closure with the module pattern.</p><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/us-fe/ebooks/edit/master/docs/en/you-dont-know-js-v2/scope-closures/ch7.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--]--> Edit this page <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: yanqi.zyq@antfin.com">yanqi</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--[--><div class="giscus-wrapper input-top" style="display:block;"><giscus-widget repo="us-fe/ebooks" repoId="R_kgDOHQs-GA" category="Announcements" categoryId="DIC_kwDOHQs-GM4CO312" lang="en" theme="light" mapping="pathname" inputPosition="top" reactionsEnabled="1" emitMetadata="0"></giscus-widget></div><!--]--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/ebooks/assets/app.a957722f.js" defer></script>
  </body>
</html>
